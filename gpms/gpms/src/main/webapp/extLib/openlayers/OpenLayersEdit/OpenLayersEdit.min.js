OpenLayers.Lang.en=OpenLayers.Util.extend(OpenLayers.Lang.en,{oleCleanFeature:"Clean selected geometry",oleDeleteFeature:"Delete selected geometry",oleDeleteAllFeatures:"Delete all geometries",oleDownloadFeature:"Download geometries",oleDownloadFeatureEmpty:"No geometries to download",oleDownloadFeatureFileFormat:"Select a file format",oleUploadFeature:"Upload geometries from local file",oleUploadFeatureNoFile:"No file specified. Please choose a file and try again.",oleUploadFeatureNone:"No or unreadable geometries found in file",
oleUploadFeatureReplace:"Replace current geometries in layer",oleDragFeature:"Drag geometry",oleDrawHole:"Draw hole",oleDrawPolygon:"Draw polygon",oleDrawPath:"Draw path",oleDrawPoint:"Draw point",oleDrawText:"Draw text label",oleDrawTextEdit:"Add label text in box,<br>then press enter or close popup",oleDrawRegular:"Draw regular polygon",oleDrawRegularShape:"Shape",oleDrawRegularIrregular:"Irregular",oleDrawRegularSides3:"triangle",oleDrawRegularSides4:"square",oleDrawRegularSides5:"pentagon",oleDrawRegularSides6:"hexagon",
oleDrawRegularCircle:"circle",oleImportFeature:"Import selected geometry",oleImportFeatureSourceLayer:"Found no source layer.",oleImportFeatureSourceFeature:"Please select a geometry first.",oleLayerSettingsImportHeader:"Import",oleLayerSettingsImportLabel:"Use as source layer",oleLayerSettingsLegendHeader:"Legend",oleLayerSettingsOpacityHeader:"Opacity (%)",oleMergeFeature:"Merge selected geometry",oleMergeFeatureSelectFeature:"Please select at least 2 geometries.",oleModifyFeature:"Modify geometry",
oleNavigation:"Navigation",olePixelUnit:"px",oleSelectFeature:"Select geometry",oleSnappingSettings:"Snapping settings",oleSnappingSettingsLayer:"Snapping layer",oleSnappingSettingsTolerance:"Snapping tolerance",oleSplitFeature:"Split selected geometry",oleTransformFeature:"Scale, rotate and move geometry",oleCADTools:"CAD Tools",oleCADToolsDialogParallelDrawing:"Parallel Drawing",oleCADToolsDialogGuidedDrawing:"Guided Drawing",oleCADToolsDialogShowLayer:"Show Guide Lines",oleCADToolsDialogTolerance:"px tolerance",
oleDialogCancelButton:"Cancel",oleDialogSaveButton:"Save",oleDialogOkButton:"Okay"});Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var d,e;if(null==this)throw new TypeError("this is null or not defined");var f=Object(this),g=f.length>>>0;if("[object Function]"!=={}.toString.call(a))throw new TypeError(a+" is not a function");b&&(d=b);for(e=0;e<g;){var h;Object.prototype.hasOwnProperty.call(f,e)&&(h=f[e],a.call(d,h,e,f));e++}});Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null==this)throw new TypeError;var b=Object(this),d=b.length>>>0;if(0===d)return-1;var e=0;0<arguments.length&&(e=Number(arguments[1]),e!=e?e=0:0!=e&&Infinity!=e&&-Infinity!=e&&(e=(0<e||-1)*Math.floor(Math.abs(e))));if(e>=d)return-1;for(e=0<=e?e:Math.max(d-Math.abs(e),0);e<d;e++)if(e in b&&b[e]===a)return e;return-1});
Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var d,e;if(null==this)throw new TypeError("this is null or not defined");var f=Object(this),g=f.length>>>0;if("[object Function]"!={}.toString.call(a))throw new TypeError(a+" is not a function");b&&(d=b);for(e=0;e<g;){var h;e in f&&(h=f[e],a.call(d,h,e,f));e++}});/*
  2011 geOps
 @license    https://github.com/geops/ole/blob/master/license.txt
 @link       https://github.com/geops/ole
*/
OpenLayers.Editor=OpenLayers.Class({map:null,id:null,editLayer:null,editorPanel:null,editMode:!1,dialog:null,showStatus:function(a,b){"error"===a&&alert(b)},activeControls:[],editorControls:"CleanFeature DeleteFeature DeleteAllFeatures Dialog DrawHole DrawRegular DrawPolygon DrawPath DrawPoint DrawText EditorPanel EditorPanel1 ImportFeature MergeFeature SnappingSettings SplitFeature CADTools TransformFeature ContextMenu".split(" "),featureTypes:["text","point","path","polygon","regular"],sourceLayers:[],
params:{},geoJSON:new OpenLayers.Format.GeoJSON,options:{},oleUrl:"",controls:{},undoRedoActive:!0,initialize:function(a,b){OpenLayers.Util.extend(this,b);this.map=a instanceof OpenLayers.Map?a:new OpenLayers.Map;b||(b={});b.dialog||(this.dialog=new OpenLayers.Editor.Control.Dialog,this.map.addControl(this.dialog));this.id=OpenLayers.Util.createUniqueID("OpenLayers.Editor_");this.editLayer=b.editLayer?b.editLayer:new OpenLayers.Layer.Vector("Editor",{displayInLayerSwitcher:!1});this.editLayer.styleMap=
b.styleMap?b.styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillColor:"#07f",fillOpacity:.8,strokeColor:"#037",strokeWidth:2,graphicZIndex:1,pointRadius:5}),defaultLabel:new OpenLayers.Style({fillColor:"#07f",fillOpacity:.8,strokeColor:"#037",strokeWidth:2,graphicZIndex:11,pointRadius:0,cursor:"default",label:"${label}",fontColor:"#000000",fontSize:"11px",fontFamily:"Verdana, Arial, Helvetica, sans-serif",fontWeight:"bold",labelOutlineColor:"#FFFFFF",labelOutlineWidth:4,labelSelect:!0}),
select:new OpenLayers.Style({fillColor:"#fc0",strokeColor:"#f70",graphicZIndex:2}),selectLabel:new OpenLayers.Style({pointRadius:5,label:"${label}",fontColor:"black",fontSize:"11px",fontFamily:"Verdana, Arial, Helvetica, sans-serif",fontWeight:"bold",labelAlign:"cm",labelXOffset:"${xOffset}",labelYOffset:"${yOffset}",fillColor:"#fc0",strokeColor:"#f70",labelOutlineColor:"#fc0",labelOutlineWidth:6,graphicZIndex:2}),temporary:new OpenLayers.Style({fillColor:"#fc0",fillOpacity:.8,strokeColor:"#f70",
strokeWidth:2,graphicZIndex:2,pointRadius:5})});var d={editor:this,layer:this.editLayer,controls:["OpenLayers.Editor.Control.DeleteFeature","OpenLayers.Editor.Control.CleanFeature","OpenLayers.Editor.Control.MergeFeature","OpenLayers.Editor.Control.SplitFeature"]};this.editLayer.events.register("featureselected",d,this.selectionChanged);this.editLayer.events.register("featureunselected",d,this.selectionChanged);for(var e=0,f=this.featureTypes.length;e<f;e++)"polygon"==this.featureTypes[e]?this.activeControls.push("DrawPolygon"):
"path"==this.featureTypes[e]?this.activeControls.push("DrawPath"):"point"==this.featureTypes[e]?this.activeControls.push("DrawPoint"):"regular"==this.featureTypes[e]?this.activeControls.push("DrawRegular"):"text"==this.featureTypes[e]&&this.activeControls.push("DrawText");e=0;for(f=this.sourceLayers.length;e<f;e++)d={editor:this,layer:this.sourceLayers[e],controls:["OpenLayers.Editor.Control.ImportFeature"]},this.sourceLayers[e].events.register("featureselected",d,this.selectionChanged),this.sourceLayers[e].events.register("featureunselected",
d,this.selectionChanged),this.sourceLayers[e].styleMap=new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillColor:"#0c0",fillOpacity:.8,strokeColor:"#070",strokeWidth:2,graphicZIndex:1,pointRadius:5}),select:new OpenLayers.Style({fillColor:"#fc0",strokeColor:"#f70",graphicZIndex:2}),temporary:new OpenLayers.Style({fillColor:"#fc0",fillOpacity:.8,strokeColor:"#f70",strokeWidth:2,graphicZIndex:2,pointRadius:5})}),this.map.addLayer(this.sourceLayers[e]);this.map.editor=this;this.map.addLayer(this.editLayer);
this.map.addControl(new OpenLayers.Editor.Control.LayerSettings(this));this.undoRedoActive&&this.map.addControl(new OpenLayers.Editor.Control.UndoRedo(this.editLayer));this.addEditorControls();return this},selectionChanged:function(){var a=this.editor.editorPanel.getControlsByClass("OpenLayers.Control.SelectFeature")[0];if(0<this.layer.selectedFeatures.length&&a&&a.active)for(var a=0,b=this.controls.length;a<b;a++){var d=this.editor.editorPanel.getControlsByClass(this.controls[a])[0];d&&OpenLayers.Element.removeClass(d.panel_div,
"oleControlDisabled")}else for(a=0,b=this.controls.length;a<b;a++)(d=this.editor.editorPanel.getControlsByClass(this.controls[a])[0])&&OpenLayers.Element.addClass(d.panel_div,"oleControlDisabled");this.editor.editorPanel.redraw()},startEditMode:function(){this.editMode=!0;this.editorPanel.activate()},stopEditMode:function(){this.editMode=!1;this.editorPanel.deactivate()},addEditorControls:function(){for(var a=null,b=[],d=0,e=this.activeControls.length;d<e;d++){a=this.activeControls[d];-1<OpenLayers.Util.indexOf(this.editorControls,
a)&&b.push(new OpenLayers.Editor.Control[a](this.editLayer,this.options[a]));switch(a){case "Separator":b.push(new OpenLayers.Control.Button({displayClass:"olControlSeparator"}));break;case "Navigation":b.push(new OpenLayers.Control.Navigation(OpenLayers.Util.extend({title:OpenLayers.i18n("oleNavigation")},this.options.Navigation)));break;case "DragFeature":b.push(new OpenLayers.Editor.Control.DragFeature(this.editLayer,OpenLayers.Util.extend({},this.options.DragFeature)));break;case "ModifyFeature":b.push(new OpenLayers.Control.ModifyFeature(this.editLayer,
OpenLayers.Util.extend({title:OpenLayers.i18n("oleModifyFeature")},this.options.ModifyFeature)));break;case "SelectFeature":b.push(new OpenLayers.Control.SelectFeature(this.sourceLayers.concat([this.editLayer]),OpenLayers.Util.extend({title:OpenLayers.i18n("oleSelectFeature"),clickout:!0,toggle:!1,multiple:!1,hover:!1,toggleKey:"ctrlKey",multipleKey:"ctrlKey",box:!0},this.options.SelectFeature)));break;case "DownloadFeature":b.push(new OpenLayers.Editor.Control.DownloadFeature(this.editLayer,OpenLayers.Util.extend({},
this.DownloadFeature)));break;case "UploadFeature":b.push(new OpenLayers.Editor.Control.UploadFeature(this.editLayer,OpenLayers.Util.extend({},this.UploadFeature)))}this.controls[a]=b[b.length-1]}this.editorPanel=this.createEditorPanel(b);this.map.addControl(this.editorPanel)},addEditorControl:function(a){this.controls[a.CLASS_NAME]=a;this.editorPanel.addControls([a]);this.map.addControl(a)},createEditorPanel:function(a){if(this.controls.ContextMenu){for(var b=this.controls.ContextMenu.contextMenuControls||
[],d=b.length;d--;){var e=a.indexOf(this.controls[b[d]]);~e&&a.splice(e,1)}a.splice(a.indexOf(this.controls.ContextMenu),1)}b=new OpenLayers.Editor.Control.EditorPanel(this);b.addControls(a);return b},status:function(a){"error"==a.type&&alert(a.content)},loadFeatures:function(a){this.editLayer.destroyFeatures();a&&(this.editLayer.addFeatures(a),this.map.zoomToExtent(this.editLayer.getDataExtent()))},requestComplete:function(a){a=(new OpenLayers.Format.JSON).read(a.responseText);this.map.editor.stopWaiting();
a?a.error?this.showStatus("error",a.message):(a.params&&OpenLayers.Util.extend(this.params,a.params),a.geo&&(a=this.geoJSON.read(a.geo),this.editLayer.removeFeatures(this.editLayer.selectedFeatures),this.editLayer.addFeatures(this.toFeatures(a)),this.editLayer.events.triggerEvent("featureselected"))):this.showStatus("error",OpenLayers.i18n("oleNoJSON"))},toFeatures:function(a){if(null===a||"object"!==typeof a)throw Error("Parameter does not match expected type.");var b=[];a instanceof Array||(a=[a]);
for(var d=0,e=a.length;d<e;d++)if("OpenLayers.Geometry.MultiPolygon"===a[d].geometry.CLASS_NAME||"OpenLayers.Geometry.Collection"===a[d].geometry.CLASS_NAME)for(var f=0,g=a[d].geometry.components.length;f<g;f++)b.push(new OpenLayers.Feature.Vector(a[d].geometry.components[f]));else"OpenLayers.Geometry.Polygon"===a[d].geometry.CLASS_NAME&&b.push(new OpenLayers.Feature.Vector(a[d].geometry));return b},toMultiPolygon:function(a){for(var b=[],d=0,e=a.length;d<e;d++)"OpenLayers.Geometry.Polygon"===a[d].geometry.CLASS_NAME&&
b.push(a[d].geometry);return new OpenLayers.Geometry.MultiPolygon(b)},startWaiting:function(a){OpenLayers.Element.addClass(a,"olEditorWaiting");OpenLayers.Element.addClass(this.map.div,"olEditorWaiting");this.waitingDiv=a},stopWaiting:function(){OpenLayers.Element.removeClass(this.waitingDiv,"olEditorWaiting");OpenLayers.Element.removeClass(this.map.div,"olEditorWaiting")},CLASS_NAME:"OpenLayers.Editor"});
OpenLayers.Editor.Control=OpenLayers.Class(OpenLayers.Control,{initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a])},CLASS_NAME:"OpenLayers.Editor.Control"});OpenLayers.Editor.VERSION_NUMBER="1.0-beta4";OpenLayers.Editor.Control.CleanFeature=OpenLayers.Class(OpenLayers.Control.Button,{proxy:null,title:OpenLayers.i18n("oleCleanFeature"),initialize:function(a,b){this.layer=a;OpenLayers.Control.Button.prototype.initialize.apply(this,[b]);this.trigger=this.cleanFeature;this.title=OpenLayers.i18n("oleCleanFeature");this.displayClass="oleControlDisabled "+this.displayClass},cleanFeature:function(){if(0<this.layer.selectedFeatures.length){var a=(new OpenLayers.Format.WKT).write(this.layer.selectedFeatures);
this.map.editor.startWaiting(this.panel_div);OpenLayers.Request.POST({url:this.map.editor.oleUrl+"process/clean",data:OpenLayers.Util.getParameterString({geo:a}),headers:{"Content-Type":"application/x-www-form-urlencoded"},callback:this.map.editor.requestComplete,proxy:this.proxy,scope:this.map.editor})}},CLASS_NAME:"OpenLayers.Editor.Control.CleanFeature"});/*
  2015 geOps
 @license    https://github.com/geops/ole/blob/master/license.txt
 @link       https://github.com/geops/ole
*/
OpenLayers.Editor.Control.ContextMenu=OpenLayers.Class(OpenLayers.Control.Panel,{type:OpenLayers.Control.TYPE_BUTTON,menuBufferDistance:10,contextMenuControls:"CleanFeature DeleteFeature DrawHole MergeFeature SplitFeature TransformFeature".split(" "),initialize:function(a,b){a.events.register("featureselected",this,this.openContextMenu);a.events.register("featureunselected",this,this.closeContextMenu);a.map.events.register("move",this,this.updatePosition);OpenLayers.Control.Panel.prototype.initialize.apply(this,
[b]);a.map.addControl(this)},addContextMenuControls:function(){for(var a=[],b=0;b<this.contextMenuControls.length;b++){var d=this.map.editor.controls[this.contextMenuControls[b]];d&&a.push(d)}this.addControls(a)},openContextMenu:function(){this.div.style.display="";this.addContextMenuControls();this.activate();this.updatePosition();for(var a=0;a<this.controls.length;a++)OpenLayers.Element.removeClass(this.controls[a].panel_div,"oleControlDisabled")},closeContextMenu:function(){this.map.editor.editLayer.selectedFeatures.length||
(this.div.style.display="none",this.deactivate())},updatePosition:function(){var a=this.map.editor.editLayer.selectedFeatures;if(a.length){for(var b=new OpenLayers.Bounds,d=this.map.getExtent().getCenterLonLat(),d=new OpenLayers.Geometry.Point(d.lon,d.lat),e=0;e<(a||[]).length;e++)b.extend(a[e].geometry.getBounds());a=b.toGeometry().distanceTo(d,{details:!0})||{x0:b.left,y0:b.top};d=this.map.getPixelFromLonLat(new OpenLayers.LonLat(a.x0,a.y0));this.div.style.right="initial";this.div.style.left=d.x+
"px";this.div.style.top=d.y+"px";a.y0===b.top?this.div.style.top=parseInt(this.div.style.top)-this.menuBufferDistance-this.div.clientHeight+"px":a.y0===b.bottom&&(this.div.style.top=parseInt(this.div.style.top)+this.menuBufferDistance+"px");a.x0===b.left?this.div.style.left=parseInt(this.div.style.left)-this.menuBufferDistance-this.div.clientWidth+"px":a.x0===b.right&&(this.div.style.left=parseInt(this.div.style.left)+this.menuBufferDistance+"px")}},CLASS_NAME:"oleContextMenu OpenLayers.Editor.Control.EditorPanel"});OpenLayers.Editor.Control.DragFeature=OpenLayers.Class(OpenLayers.Control.DragFeature,{title:OpenLayers.i18n("oleDragFeature"),EVENT_TYPES:"activate deactivate dragstart dragdrag dragcomplete dragenter dragleave".split(" "),initialize:function(a,b){OpenLayers.Control.DragFeature.prototype.initialize.apply(this,[a,b]);this.title=OpenLayers.i18n("oleDragFeature")},onStart:function(a,b){this.events.triggerEvent("dragstart",{feature:a,pixel:b})},onDrag:function(a,b){this.events.triggerEvent("dragdrag",
{feature:a,pixel:b})},onComplete:function(a,b){this.events.triggerEvent("dragcomplete",{feature:a,pixel:b});this.layer.events.triggerEvent("afterfeaturemodified",{feature:a})},onEnter:function(a){this.events.triggerEvent("dragenter",{feature:a})},onLeave:function(a){this.events.triggerEvent("dragleave",{feature:a})},CLASS_NAME:"OpenLayers.Editor.Control.DragFeature"});OpenLayers.Editor.Control.DeleteFeature=OpenLayers.Class(OpenLayers.Control.Button,{layer:null,title:OpenLayers.i18n("oleDeleteFeature"),initialize:function(a,b){this.layer=a;this.title=OpenLayers.i18n("oleDeleteFeature");OpenLayers.Control.Button.prototype.initialize.apply(this,[b]);this.trigger=this.deleteFeature;this.displayClass="oleControlDisabled "+this.displayClass},deleteFeature:function(){0<this.layer.selectedFeatures.length&&(this.layer.destroyFeatures(this.layer.selectedFeatures),this.layer.events.triggerEvent("featureunselected"))},
CLASS_NAME:"OpenLayers.Editor.Control.DeleteFeature"});/*
  2011 geOps
 @author     Just van den Broecke
 @license    https://github.com/geops/ole/blob/master/license.txt
 @link       https://github.com/geops/ole
*/
OpenLayers.Editor.Control.DeleteAllFeatures=OpenLayers.Class(OpenLayers.Control.Button,{layer:null,title:OpenLayers.i18n("oleDeleteAllFeatures"),initialize:function(a,b){this.layer=a;this.title=OpenLayers.i18n("oleDeleteAllFeatures");OpenLayers.Control.Button.prototype.initialize.apply(this,[b]);this.trigger=this.deleteAllFeatures;this.displayClass="oleControlEnabled "+this.displayClass},deleteAllFeatures:function(){0<this.layer.features.length&&this.layer.destroyFeatures();this.map.editor.editLayer&&
this.map.editor.editLayer.destroyFeatures()},CLASS_NAME:"OpenLayers.Editor.Control.DeleteAllFeatures"});OpenLayers.Editor.Control.Dialog=OpenLayers.Class(OpenLayers.Control,{dialogDiv:null,buttonClass:null,inputTextClass:null,modal:!0,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a])},show:function(a){var b,d;-1<OpenLayers.Util.indexOf(this.map.viewPortDiv.childNodes,this.dialogDiv)&&this.map.viewPortDiv.removeChild(this.dialogDiv);a||(a={});this.dialogDiv=document.createElement("div");OpenLayers.Element.addClass(this.dialogDiv,"oleDialog");a.toolbox?OpenLayers.Element.addClass(this.dialogDiv,
"oleDialogToolbar"):OpenLayers.Element.addClass(this.div,"oleFadeMap");a.title&&(b=document.createElement("h3"),b.innerHTML=a.title,this.dialogDiv.appendChild(b));"string"===typeof a.content?(b=document.createElement("div"),b.innerHTML=a.content,this.dialogDiv.appendChild(b)):OpenLayers.Util.isElement(a.content)&&this.dialogDiv.appendChild(a.content);a.save?(b=this.getButton(OpenLayers.i18n("oleDialogCancelButton")),this.dialogDiv.appendChild(b),d=this.getButton(OpenLayers.i18n(a.saveButtonText?a.saveButtonText:
"oleDialogSaveButton")),this.dialogDiv.appendChild(d),OpenLayers.Event.observe(b,"click",OpenLayers.Function.bind(this.hide,this)),a.noHideOnSave||OpenLayers.Event.observe(d,"click",OpenLayers.Function.bind(this.hide,this)),OpenLayers.Event.observe(d,"click",a.save),a.cancel&&OpenLayers.Event.observe(b,"click",a.cancel)):a.toolbox||(b=this.getButton(OpenLayers.i18n("oleDialogOkButton")),this.dialogDiv.appendChild(b),OpenLayers.Event.observe(b,"click",OpenLayers.Function.bind(this.hide,this)),a.close&&
OpenLayers.Event.observe(b,"click",a.close));a=this.dialogDiv.getElementsByTagName("input");for(b=0;b<a.length;b++)"text"==a[b].getAttribute("type")&&OpenLayers.Element.addClass(a[b],this.inputTextClass);this.map.viewPortDiv.appendChild(this.dialogDiv);OpenLayers.Event.observe(this.div,"click",this.ignoreEvent);OpenLayers.Event.observe(this.div,"mousedown",this.ignoreEvent);OpenLayers.Event.observe(this.div,"dblclick",this.ignoreEvent);OpenLayers.Event.observe(this.dialogDiv,"mousedown",this.ignoreEvent);
OpenLayers.Event.observe(this.dialogDiv,"dblclick",this.ignoreEvent)},hide:function(){this.dialogDiv&&(this.map.viewPortDiv.removeChild(this.dialogDiv),OpenLayers.Element.removeClass(this.div,"oleFadeMap"),this.dialogDiv=null)},ignoreEvent:function(a){OpenLayers.Event.stop(a,!0)},getButton:function(a){var b=document.createElement("input");b.value=a;b.type="button";OpenLayers.Element.addClass(b,this.buttonClass);return b},CLASS_NAME:"OpenLayers.Editor.Control.Dialog"});OpenLayers.Editor.Control.DrawHole=OpenLayers.Class(OpenLayers.Control.DrawFeature,{minArea:0,title:OpenLayers.i18n("oleDrawHole"),initialize:function(a,b){this.callbacks=OpenLayers.Util.extend(this.callbacks,{point:function(a){this.layer.events.triggerEvent("pointadded",{point:a})}});OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[a,OpenLayers.Handler.Polygon,b]);this.title=OpenLayers.i18n("oleDrawHole")},drawFeature:function(a){var b=new OpenLayers.Feature.Vector(a);b.state=OpenLayers.State.INSERT;
if(!1!==this.layer.events.triggerEvent("sketchcomplete",{feature:b})&&a.getArea()>=this.minArea){var b=a.getVertices(),d,e=0,f=this.layer.features.length;a:for(;e<f;e++){var g=this.layer.features[e];d=!0;for(var h=0,l=b.length;h<l;h++)g.geometry.intersects(b[h])||(d=!1);if(d){g.state=OpenLayers.State.UPDATE;this.layer.events.triggerEvent("beforefeaturemodified",{feature:g});g.geometry.components.push(a.components[0]);this.layer.drawFeature(g);this.layer.events.triggerEvent("featuremodified",{feature:g});
this.layer.events.triggerEvent("afterfeaturemodified",{feature:g});break a}}}},CLASS_NAME:"OpenLayers.Editor.Control.DrawHole"});OpenLayers.Editor.Control.DrawPolygon=OpenLayers.Class(OpenLayers.Control.DrawFeature,{minArea:0,title:OpenLayers.i18n("oleDrawPolygon"),initialize:function(a,b){this.callbacks=OpenLayers.Util.extend(this.callbacks,{point:function(a){this.layer.events.triggerEvent("pointadded",{point:a})}});OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[a,OpenLayers.Handler.Polygon,b]);this.title=OpenLayers.i18n("oleDrawPolygon")},drawFeature:function(a){var b=new OpenLayers.Feature.Vector(a);!1!==
this.layer.events.triggerEvent("sketchcomplete",{feature:b})&&a.getArea()>=this.minArea&&(b.state=OpenLayers.State.INSERT,this.layer.addFeatures([b]),this.featureAdded(b),this.events.triggerEvent("featureadded",{feature:b}))},CLASS_NAME:"OpenLayers.Editor.Control.DrawPolygon"});OpenLayers.Editor.Control.DrawPath=OpenLayers.Class(OpenLayers.Control.DrawFeature,{minLength:0,title:OpenLayers.i18n("oleDrawPath"),initialize:function(a,b){this.callbacks=OpenLayers.Util.extend(this.callbacks,{point:function(a){this.layer.events.triggerEvent("pointadded",{point:a})}});OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[a,OpenLayers.Handler.Path,b]);this.title=OpenLayers.i18n("oleDrawPath")},activate:function(){if(this.active)return!1;this.handler&&this.handler.activate();
this.active=!0;this.map&&OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active");this.events.triggerEvent("activate");return!0},drawFeature:function(a){var b=new OpenLayers.Feature.Vector(a);!1!==this.layer.events.triggerEvent("sketchcomplete",{feature:b})&&a.getLength()>=this.minLength&&(b.state=OpenLayers.State.INSERT,this.layer.addFeatures([b]),this.featureAdded(b),this.events.triggerEvent("featureadded",{feature:b}))},CLASS_NAME:"OpenLayers.Editor.Control.DrawPath"});OpenLayers.Editor.Control.DrawPoint=OpenLayers.Class(OpenLayers.Control.DrawFeature,{title:OpenLayers.i18n("oleDrawPoint"),featureType:"point",initialize:function(a,b){this.callbacks=OpenLayers.Util.extend(this.callbacks,{point:function(a){this.layer.events.triggerEvent("pointadded",{point:a})}});OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[a,OpenLayers.Handler.Point,b]);this.title=OpenLayers.i18n("oleDrawPoint")},drawFeature:function(a){a=new OpenLayers.Feature.Vector(a);var b=
this.layer.events.triggerEvent("sketchcomplete",{feature:a});a.featureType=this.featureType;!1!==b&&(this.events.triggerEvent("beforefeatureadded",{feature:a}),a.state=OpenLayers.State.INSERT,this.layer.addFeatures([a]),this.featureAdded(a),this.events.triggerEvent("featureadded",{feature:a}))},CLASS_NAME:"OpenLayers.Editor.Control.DrawPoint"});OpenLayers.Editor.Control.DrawText=OpenLayers.Class(OpenLayers.Editor.Control.DrawPoint,{title:null,featureType:"text",defaultStyle:"defaultLabel",selectStyle:"selectLabel",modal:!0,initialize:function(a,b){OpenLayers.Editor.Control.DrawPoint.prototype.initialize.apply(this,[a,OpenLayers.Handler.Point,b]);this.title=OpenLayers.i18n("oleDrawText");a.events.on({beforefeatureadded:this.onBeforeFeatureAdded,featureselected:this.onFeatureSelected,featureunselected:this.onFeatureUnselected,scope:this})},
deactivate:function(){OpenLayers.Control.Button.prototype.deactivate.call(this);if(this.popup&&this.popup.feature){var a=this.popup.feature;a.layer&&(a.layer.map.removePopup(a.popup),a.layer.removeFeatures([a]));a.popup.destroy();this.popup=a.popup=null}},setLabelText:function(a,b){a.attributes.label=b;a.layer.drawFeature(a,this.defaultStyle)},removePopup:function(a){this.popup=null;a.popup&&(a.layer.map.removePopup(a.popup),a.popup.destroy(),a.popup=null,(a=a.editControl)&&a.activate())},onPopupClose:function(a){this.popup=
null;a=this.feature;if(!a)return!1;var b=a.editControl;if(!b)return!1;var d=document.getElementById("olLabelInput");b.setLabelText(a,d.value);b.removePopup(a);d.value||a.layer.removeFeatures([a])},isTextFeature:function(a){return a?"text"===a.featureType:!1},onFeatureSelected:function(a){a=a.feature;this.isTextFeature(a)&&a.layer.drawFeature(a,this.selectStyle)},onFeatureUnselected:function(a){a=a.feature;this.isTextFeature(a)&&a.layer.drawFeature(a,this.defaultStyle)},onBeforeFeatureAdded:function(a){var b=
a.feature;if(!this.isTextFeature(b))return b.attributes.label&&(b.editControl=this,b.featureType="text",b.layer.drawFeature(b,this.defaultStyle)),!0;a=new OpenLayers.Popup.FramedCloud("featurePopup",b.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(100,100),'<div class="oleDrawTextPopup"><input type="text" size="32" id="olLabelInput"/><p>'+OpenLayers.i18n("oleDrawTextEdit")+"</p></div>",null,!0,this.onPopupClose);b.popup=a;b.editControl=this;a.feature=b;this.layer.map.addPopup(a,!0);this.deactivate();
var d=document.getElementById("olLabelInput"),e=this;d.onkeypress=function(a){13==(window.event?window.event.keyCode:a.keyCode)&&(e.setLabelText(b,d.value),e.removePopup(b))};d.focus();this.popup=a},CLASS_NAME:"OpenLayers.Editor.Control.DrawText"});OpenLayers.Editor.Control.DrawRegular=OpenLayers.Class(OpenLayers.Control.DrawFeature,{minArea:0,title:OpenLayers.i18n("oleDrawRegular"),sides:[3,4,5,6,40],initialize:function(a,b){this.callbacks=OpenLayers.Util.extend(this.callbacks,{point:function(a){this.layer.events.triggerEvent("pointadded",{point:a})}});OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[a,OpenLayers.Handler.RegularPolygon,b]);this.title=OpenLayers.i18n("oleDrawRegular")},activate:function(){var a=OpenLayers.Control.Button.prototype.activate.call(this),
b,d,e;b=document.createElement("div");d=document.createElement("div");OpenLayers.Element.addClass(d,"oleDrawRegularIrregular");e=document.createElement("input");e.type="checkbox";e.id="oleCADToolsDialogIrregular";e.value="true";OpenLayers.Event.observe(e,"change",OpenLayers.Function.bind(function(a){this.handler.setOptions({irregular:a.target.checked})},this));d.appendChild(e);e=document.createElement("label");e.htmlFor="oleCADToolsDialogIrregular";e.appendChild(document.createTextNode(OpenLayers.i18n("oleDrawRegularIrregular")));
d.appendChild(e);b.appendChild(d);d=document.createElement("div");e=document.createElement("select");e.id="oleCADToolsDialogSides";for(var f=0;f<this.sides.length;++f){var g=20>this.sides[f]?OpenLayers.i18n("oleDrawRegularSides"+this.sides[f]):OpenLayers.i18n("oleDrawRegularCircle");e.options.add(new Option(g,this.sides[f]))}OpenLayers.Event.observe(e,"change",OpenLayers.Function.bind(function(a){this.handler.setOptions({sides:parseInt(a.target.value)})},this));this.handler.setOptions({sides:parseInt(e.value)});
d.appendChild(e);e=document.createElement("label");e.htmlFor="oleCADToolsDialogSides";e.appendChild(document.createTextNode(OpenLayers.i18n("oleDrawRegularShape")));d.appendChild(e);b.appendChild(d);this.map.editor.dialog.show({content:b,toolbox:!0});return a},deactivate:function(){var a=OpenLayers.Control.Button.prototype.deactivate.call(this);a&&"function"==typeof this.map.editor.dialog.hide&&this.map.editor.dialog.hide();return a},drawFeature:function(a){var b=new OpenLayers.Feature.Vector(a);
!1!==this.layer.events.triggerEvent("sketchcomplete",{feature:b})&&a.getArea()>=this.minArea&&(b.state=OpenLayers.State.INSERT,this.layer.addFeatures([b]),this.featureAdded(b),this.events.triggerEvent("featureadded",{feature:b}))},CLASS_NAME:"OpenLayers.Editor.Control.DrawRegular"});OpenLayers.Editor.Control.EditorPanel=OpenLayers.Class(OpenLayers.Control.Panel,{autoActivate:!1,initialize:function(a,b){OpenLayers.Control.Panel.prototype.initialize.apply(this,[b])},draw:function(){OpenLayers.Control.Panel.prototype.draw.apply(this,arguments);this.active||(this.div.style.display="none");return this.div},redraw:function(){this.active||(this.div.style.display="none");OpenLayers.Control.Panel.prototype.redraw.apply(this,arguments);this.active&&(this.div.style.display="")},CLASS_NAME:"OpenLayers.Editor.Control.EditorPanel"});OpenLayers.Editor.Control.ImportFeature=OpenLayers.Class(OpenLayers.Control.Button,{layer:null,title:OpenLayers.i18n("oleImportFeature"),initialize:function(a,b){this.layer=a;OpenLayers.Control.Button.prototype.initialize.apply(this,[b]);this.trigger=this.importFeature;this.title=OpenLayers.i18n("oleImportFeature");this.displayClass="oleControlDisabled "+this.displayClass},importFeature:function(){var a=[];if(0<this.map.editor.sourceLayers.length){for(var b=0,d=this.map.editor.sourceLayers.length;b<
d;b++){for(var e=0,f=this.map.editor.sourceLayers[b].selectedFeatures.length;e<f;e++)this.map.editor.sourceLayers[b].selectedFeatures[e].renderIntent="default",a.push(this.map.editor.sourceLayers[b].selectedFeatures[e]);this.map.editor.sourceLayers[b].removeFeatures(this.map.editor.sourceLayers[b].selectedFeatures);this.map.editor.sourceLayers[b].events.triggerEvent("featureunselected")}if(0<a.length)this.layer.addFeatures(a);else return this.map.editor.showStatus("error",OpenLayers.i18n("oleImportFeatureSourceFeature"))}else return this.map.editor.showStatus("error",
OpenLayers.i18n("oleImportFeatureSourceLayer"))},CLASS_NAME:"OpenLayers.Editor.Control.ImportFeature"});OpenLayers.Editor.Control.LayerSettings=OpenLayers.Class(OpenLayers.Control,{currentLayer:null,layerSwitcher:null,initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);this.layerSwitcher=a.map.getControlsByClass("OpenLayers.Control.LayerSwitcher")[0];this.layerSwitcher instanceof OpenLayers.Control.LayerSwitcher&&OpenLayers.Event.observe(this.layerSwitcher.maximizeDiv,"click",OpenLayers.Function.bind(this.redraw,this))},destroy:function(){this.map.events.un({addlayer:this.redraw,
changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this});OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this})},redraw:function(){if("undefined"!=typeof layerSwitcher)for(var a=0,b=this.layerSwitcher.dataLayers.length;a<b;a++){var d=this.layerSwitcher.dataLayers[a];
OpenLayers.Element.removeClass(d.labelSpan,"olButton");OpenLayers.Event.observe(d.labelSpan,"click",OpenLayers.Function.bind(this.showLayerSettings,this,d.layer.name))}},showLayerSettings:function(a){var b,d,e,f;this.currentLayer=this.map.getLayersByName(a)[0];b=document.createElement("div");d=document.createElement("h4");d.innerHTML=OpenLayers.i18n("oleLayerSettingsOpacityHeader");b.appendChild(d);f=this.currentLayer.opacity?this.currentLayer.opacity:1;d=document.createElement("input");d.type="text";
d.size="2";d.value=(100*f).toFixed(0);OpenLayers.Event.observe(d,"change",OpenLayers.Function.bind(this.changeLayerOpacity,this,d));b.appendChild(d);if(this.currentLayer instanceof OpenLayers.Layer.Vector){d=document.createElement("h4");d.innerHTML=OpenLayers.i18n("oleLayerSettingsImportHeader");d.style.marginTop="10px";b.appendChild(d);f=document.createElement("input");f.type="checkbox";f.name="import"+this.currentLayer.name;b.appendChild(f);d=document.createElement("label");d.htmlFor="import"+this.currentLayer.name;
d.innerHTML=OpenLayers.i18n("oleLayerSettingsImportLabel");b.appendChild(d);b.appendChild(document.createElement("p"));d=0;for(e=this.map.editor.sourceLayers.length;d<e;d++)if(this.currentLayer.id==this.map.editor.sourceLayers[d].id){f.writeAttribute("checked","checked");f.defaultChecked="selected";break}OpenLayers.Event.observe(f,"click",OpenLayers.Function.bind(this.toggleExportFeature,this))}f=this.getLegendGraphics(this.currentLayer);if(0<f.length)for(d=document.createElement("h4"),d.innerHTML=
OpenLayers.i18n("oleLayerSettingsLegendHeader"),d.style.marginTop="10px",b.appendChild(d),d=0;d<f.length;d++)e=document.createElement("img"),e.src=f[d],b.appendChild(e);this.map.editor.dialog.show({content:b,title:a})},toggleExportFeature:function(){for(var a=!0,b=0,d=this.map.editor.sourceLayers.length;b<d;b++)if(this.currentLayer.id==this.map.editor.sourceLayers[b].id){this.map.editor.sourceLayers.splice(b,1);a=!1;break}a&&this.map.editor.sourceLayers.push(this.currentLayer)},toggleLayerVisibility:function(a){a=
this.map.getLayersByName(a)[0];a.visibility?a.setVisibility(!1):a.setVisibility(!0);this.redraw()},changeLayerOpacity:function(a){this.currentLayer.setOpacity(a.value/100)},getLegendGraphics:function(a){var b=[];if(a.legendGraphics)b=a.legendGraphics;else if(a instanceof OpenLayers.Layer.WMS)for(var d=a.params.LAYERS.split(","),e=0;e<d.length;e++){var f=d[e],g=a.url,g=g+(-1===g.indexOf("?")?"?":""),g=g+"&SERVICE=WMS",g=g+"&VERSION=1.1.1",g=g+"&REQUEST=GetLegendGraphic",g=g+"&FORMAT=image/png",g=g+
("&LAYER="+f);b.push(g)}return b},CLASS_NAME:"OpenLayers.Editor.Control.LayerSettings"});OpenLayers.Editor.Control.TransformFeature=OpenLayers.Class(OpenLayers.Control.TransformFeature,{CLASS_NAME:"OpenLayers.Editor.Control.TransformFeature",editLayer:null,strategiesOnHold:null,drawOriginalsFeature:null,drawOriginalsRenderIntent:null,initialize:function(a){this.strategiesOnHold=[];OpenLayers.Control.TransformFeature.prototype.initialize.call(this,a,{renderIntent:"transform",rotationHandleSymbolizer:"rotate"});this.editLayer=a;this.addStyles();this.events.on({transformcomplete:function(a){a.feature.state=
OpenLayers.State.UPDATE;this.editLayer.events.triggerEvent("afterfeaturemodified",{feature:a.feature})},scope:this});this.title=OpenLayers.i18n("oleTransformFeature")},addStyles:function(){var a=this;this.editLayer.styleMap.styles.transform=new OpenLayers.Style({display:"${getDisplay}",cursor:"${role}",pointRadius:5,fillColor:"#07f",strokeOpacity:"${getStrokeOpacity}",fillOpacity:1,strokeColor:"${getStrokeColor}",strokeWidth:"${getStrokeWidth}",strokeDashstyle:"${getStrokeDashstyle}"},{context:{getDisplay:function(b){return null===
a.feature||a.feature.geometry instanceof OpenLayers.Geometry.Point?"none":"se-resize"===b.attributes.role?"none":""},getStrokeColor:function(a){return a.geometry instanceof OpenLayers.Geometry.Point?"#037":"#ff00ff"},getStrokeOpacity:function(a){return a.geometry instanceof OpenLayers.Geometry.Point?.8:.5},getStrokeWidth:function(a){return a.geometry instanceof OpenLayers.Geometry.Point?2:1},getStrokeDashstyle:function(a){return a.geometry instanceof OpenLayers.Geometry.Point?"solid":"longdash"}}});
this.editLayer.styleMap.styles.rotate=new OpenLayers.Style({display:"${getDisplay}",pointRadius:10,fillColor:"#ddd",fillOpacity:1,strokeColor:"black",externalGraphic:"msie"===OpenLayers.Util.getBrowserName()?void 0:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAWCAYAAAArdgcFAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAAOnAAADnUBiCgbeAAAAAd0SU1FB9wIAgsPAyGVVyoAAAQFSURBVDjLjZVfTJNnFMZ//aQ0UVMgIi11Kngx1KUGBo0XU+bmmFnmErzRkBK2RBMUyfaV4cQ4t5GNm8UMTJTMbDSj4YI5GFmcMxvyZ4yIJJUbY5GNJv7ZQtGJNBoTL+yzC+NnugJykpO8Oe85z/u85z3vOUhiPj13tsfcX71PGzesV0ZGhgA5nU5tWF+gfXvf0089Z8yF4uc0XvjtnOkrKRbwXC1+uUjnzvaYiwL/4vNPtWTJEgHKyclRTU2Nurq6FA6HFY1GdfnyZXV3d+vgwYPKyckRIMMw9MnHR7Qg+Id1HwiQzWZTdXW1rly5omg0Oq9evXpVtbW1MgxDgGpr9mtO8OC3X5s2m01paWk6derUgqD/19OnT8tutwtQ68kTVopskgDIzl6hu3dnaGxspLKykvnk4cOHRCKRJJvD4eDatWs0NDSQkeFkdjZuA54wP1QfEKDNmzc/l6Xf70951DVr1igajaq0tFSA3q+tkSQMgO/PdAFgmmYSo4mJiRTm9+/ft9Z1dXWEQiGOHz8OQCAQAOCHrh8BMEaGB8ybN2/hcrnw+XxWYDgcZufOnfT29qYckJmZSV5eHu3t7Xi9XoqLiwHYtGkTq1evZioWY7D/V9P486/JZoDCwkJsNpsF0NLSgsfjobS0NAV86dKltLa2MjMzQygUStorKSkBYHx8otmYmooBkJubazk8evSI0dFRdu3ahcPhmPNhCwoKKCoqYmhoKMm+cuVKAGKxGGlP2SYSCcshHo+TSCRwu90poKZp8uDBAwBcLhfj4+NJ+0+rzzAM0jyeJ4ynpqYsh6ysLNLT07l+/XoK+Nq1a631jRs3Ugjcvn0bALfbhVFQ8GIAYGxsjMePHwNgt9vZtm0b3d3d3Lt3b860XLx4kUgkQllZWRLrS5cuAfDSxg0BJJGfnydA7e3tVj2fP39eDodDXq9Xg4ODSbXe0dGhrKws5efnKxKJWPbOzk4BWrXKI+v7HzvaIECFhYWanJy0nNva2rRs2TLZ7XZt3bpV5eXl8nq9ArRu3ToNDAwkHerz+QToUH1ASd8/1+1WbHqa+vp6Dhw4YF11enqaYDDIyMgI8Xgct9vNjh078Pv9SZUUDAZpamoiO3sFd+78awOegZ/p7DAr/O82AzQ1NbF7924WKz09PRw+fJhEIkHou2+orNr7rLc81cbPjln9Ys+ePVYPn0/D4bCqqqqsmKNHPtKCw6L15Ak5HOkCtHz5clVUVKitrU19fX0aGxtTf3+/gsGg/H6/nE6nANntdrV89aUWNeZGR4bMN8u2L2rMbX/9NQ3/fmHOMWflfC4ZGR4wz/78S/PQH8Pc+vsfZmfjZGZm8MIqD1u2vMI7b78V2PLqGy3zxf8Hbd5G4wGXKsEAAAAASUVORK5CYII=",
graphicWidth:23,graphicHeight:22},{context:{getDisplay:function(b){return null===a.feature||a.feature.geometry instanceof OpenLayers.Geometry.Point?"none":"se-rotate"===b.attributes.role?"":"none"}}})},activate:function(){for(var a=0;OpenLayers.Util.isArray(this.layer.strategies)&&a<this.layer.strategies.length;a++)this.layer.strategies[a]instanceof OpenLayers.Strategy.BBOX&&(this.strategiesOnHold.push(this.layer.strategies[a]),this.layer.strategies[a].deactivate());a=OpenLayers.Control.TransformFeature.prototype.activate.call(this);
if(null===this.feature||this.feature.geometry instanceof OpenLayers.Geometry.Point){this.editLayer.drawFeature(this.box,this.renderIntent);var b,d;for(d=0;d<this.rotationHandles.length;d++)b=this.rotationHandles[d],this.editLayer.drawFeature(b,this.renderIntent);for(d=0;d<this.handles.length;d++)b=this.handles[d],this.editLayer.drawFeature(b,this.renderIntent)}this.events.on({setfeature:this.highlightTransformedFeature,scope:this});return a},deactivate:function(){this._moving=!0;this.box.geometry.rotate(-this.rotation,
this.center);delete this._moving;for(var a=0;a<this.strategiesOnHold.length;a++)this.strategiesOnHold[a].activate();a=OpenLayers.Control.TransformFeature.prototype.deactivate.apply(this,arguments);this.unsetFeature();this.events.un({setfeature:this.highlightTransformedFeature,scope:this});this.drawOriginalsFeature&&(this.layer.drawFeature(this.drawOriginalsFeature,this.drawOriginalsRenderIntent),this.drawOriginalsRenderIntent=this.drawOriginalsFeature=null);return a},highlightTransformedFeature:function(a){this.drawOriginalsFeature&&
this.layer.drawFeature(this.drawOriginalsFeature,this.drawOriginalsRenderIntent);this.drawOriginalsFeature=a.feature;this.drawOriginalsRenderIntent=a.feature.renderIntent;this.layer.drawFeature(a.feature,"select")},createBox:function(){var a=this;this.center=new OpenLayers.Geometry.Point(0,0);this.box=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(-1,-1),new OpenLayers.Geometry.Point(0,-1),new OpenLayers.Geometry.Point(1,-1),new OpenLayers.Geometry.Point(1,
0),new OpenLayers.Geometry.Point(1,1),new OpenLayers.Geometry.Point(0,1),new OpenLayers.Geometry.Point(-1,1),new OpenLayers.Geometry.Point(-1,0),new OpenLayers.Geometry.Point(-1,-1)]),null,"string"==typeof this.renderIntent?null:this.renderIntent);this.box.geometry.move=function(b,d){a._moving=!0;OpenLayers.Geometry.LineString.prototype.move.apply(this,arguments);a.center.move(b,d);delete a._moving};for(var b=function(a,b){OpenLayers.Geometry.Point.prototype.move.apply(this,arguments);this._rotationHandle&&
this._rotationHandle.geometry.move(a,b);this._handle.geometry.move(a,b)},d=function(a,b,d){OpenLayers.Geometry.Point.prototype.resize.apply(this,arguments);this._rotationHandle&&this._rotationHandle.geometry.resize(a,b,d);this._handle.geometry.resize(a,b,d)},e=function(a,b){OpenLayers.Geometry.Point.prototype.rotate.apply(this,arguments);this._rotationHandle&&this._rotationHandle.geometry.rotate(a,b);this._handle.geometry.rotate(a,b)},f=function(b,d){var e=this.x,f=this.y;OpenLayers.Geometry.Point.prototype.move.call(this,
b,d);if(!a._moving){var g=a.dragControl.handlers.drag.evt,h=!(!a._setfeature&&a.preserveAspectRatio)&&!(g&&g.shiftKey),l=new OpenLayers.Geometry.Point(e,f),g=a.center;this.rotate(-a.rotation,g);l.rotate(-a.rotation,g);var k=this.x-g.x,p=this.y-g.y,m=k-(this.x-l.x),n=p-(this.y-l.y);a.irregular&&!a._setfeature&&(k-=(this.x-l.x)/2,p-=(this.y-l.y)/2);this.x=e;this.y=f;l=1;a.feature.geometry instanceof OpenLayers.Geometry.Point?h=1:h?(h=1E-5>Math.abs(n)?1:p/n,l=(1E-5>Math.abs(m)?1:k/m)/h):h=Math.sqrt(k*
k+p*p)/Math.sqrt(m*m+n*n);a._moving=!0;a.box.geometry.rotate(-a.rotation,g);delete a._moving;a.box.geometry.resize(h,g,l);a.box.geometry.rotate(a.rotation,g);a.transformFeature({scale:h,ratio:l});a.irregular&&!a._setfeature&&(k=g.clone(),k.x+=1E-5>Math.abs(e-g.x)?0:this.x-e,k.y+=1E-5>Math.abs(f-g.y)?0:this.y-f,a.box.geometry.move(this.x-e,this.y-f),a.transformFeature({center:k}))}},g=function(b,d){var e=this.x,f=this.y;OpenLayers.Geometry.Point.prototype.move.call(this,b,d);if(!a._moving){var g=a.dragControl.handlers.drag.evt,
g=g&&g.shiftKey?45:1,h=a.center,l=this.x-h.x,k=this.y-h.y;this.x=e;this.y=f;e=Math.atan2(k,l)-Math.atan2(k-d,l-b);e*=180/Math.PI;a._angle=(a._angle+e)%360;e=a.rotation%g;if(Math.abs(a._angle)>=g||0!==e)e=Math.round(a._angle/g)*g-e,a._angle=0,a.box.geometry.rotate(e,h),a.transformFeature({rotation:e})}},h=Array(8),l=Array(4),k,n,p,q="sw s se e ne n nw w".split(" "),m=0;8>m;++m)k=this.box.geometry.components[m],n=new OpenLayers.Feature.Vector(k.clone(),{role:q[m]+"-resize"},"string"==typeof this.renderIntent?
null:this.renderIntent),0==m%2&&(p=new OpenLayers.Feature.Vector(k.clone(),{role:q[m]+"-rotate"},"string"==typeof this.rotationHandleSymbolizer?null:this.rotationHandleSymbolizer),p.geometry.move=g,k._rotationHandle=p,l[m/2]=p),k.move=b,k.resize=d,k.rotate=e,n.geometry.move=f,k._handle=n,h[m]=n;this.rotationHandles=l;this.handles=h}});OpenLayers.Editor.Control.MergeFeature=OpenLayers.Class(OpenLayers.Control.Button,{proxy:null,title:OpenLayers.i18n("oleMergeFeature"),initialize:function(a,b){this.layer=a;OpenLayers.Control.Button.prototype.initialize.apply(this,[b]);this.trigger=this.mergeFeature;this.title=OpenLayers.i18n("oleMergeFeature");this.displayClass="oleControlDisabled "+this.displayClass},mergeFeature:function(){if(2>this.layer.selectedFeatures.length)this.map.editor.showStatus("error",OpenLayers.i18n("oleMergeFeatureSelectFeature"));
else{var a=(new OpenLayers.Format.WKT).write(this.layer.selectedFeatures);this.map.editor.startWaiting(this.panel_div);OpenLayers.Request.POST({url:this.map.editor.oleUrl+"process/merge",data:OpenLayers.Util.getParameterString({geo:a}),headers:{"Content-Type":"application/x-www-form-urlencoded"},callback:this.map.editor.requestComplete,proxy:this.proxy,scope:this.map.editor})}},CLASS_NAME:"OpenLayers.Editor.Control.MergeFeature"});OpenLayers.Editor.Control.FixedAngleDrawing=OpenLayers.Class(OpenLayers.Control,{CLASS_NAME:"OpenLayers.Editor.Control.FixedAngleDrawing",active:!1,sketchVerticesAmount:null,guides:null,initialize:function(a){this.guides=[];OpenLayers.Control.prototype.initialize.call(this);this.layer=a},activate:function(){var a=OpenLayers.Control.prototype.activate.call(this);if(a)this.layer.events.on({sketchstarted:this.onSketchStarted,sketchmodified:this.onSketchModified,sketchcomplete:this.onSketchComplete,scope:this});
return a},deactivate:function(){var a=OpenLayers.Control.prototype.deactivate.call(this);a&&this.layer.events.un({sketchstarted:this.onSketchStarted,sketchmodified:this.onSketchModified,sketchcomplete:this.onSketchComplete,scope:this});return a},onSketchModified:function(a){a=a.feature.geometry.getVertices();if(2<a.length&&this.sketchVerticesAmount!==a.length){this.removeGuides();this.sketchVerticesAmount=a.length;this.updateGuideLines(a[a.length-3],a[a.length-2]);var b=this.getSnappingGuideLayer(),
d=-1/b.getLine({x1:a[0].x,y1:a[0].y,x2:a[1].x,y2:a[1].y}).m;this.guides.push(b.addLine({m:d,b:a[0].y-d*a[0].x}))}},onSketchComplete:function(){this.removeGuides()},removeGuides:function(){this.getSnappingGuideLayer().removeFeatures(this.guides);this.guides=[]},onSketchStarted:function(a){var b=a.feature,d;if(b.geometry instanceof OpenLayers.Geometry.LineString||b.geometry instanceof OpenLayers.Geometry.Polygon){for(a=0;a<this.map.controls.length;a++){var e=this.map.controls[a];if(e.active&&e.handler instanceof
OpenLayers.Handler.Path){d=e.handler.layer;break}}d.events.on({featureremoved:function(a){a.feature.id===b.id&&(this.sketchVerticesAmount=null,this.getSnappingGuideLayer().destroyFeatures())},scope:this})}},getSnappingGuideLayer:function(){return this.map.getLayersByClass("OpenLayers.Editor.Layer.Snapping")[0]},updateGuideLines:function(a,b){var d=this.getSnappingGuideLayer(),e=-1/((b.y-a.y)/(b.x-a.x));this.guides.push(d.addLine({m:e,b:b.y-e*b.x,x:b.x}))}});OpenLayers.Editor.Layer=OpenLayers.Class(OpenLayers.Layer,{initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,[a])},CLASS_NAME:"OpenLayers.Editor.Layer"});OpenLayers.Editor.Layer.Snapping=OpenLayers.Class(OpenLayers.Layer.Vector,{CLASS_NAME:"OpenLayers.Editor.Layer.Snapping",intersectionPoints:null,initialize:function(a,b){this.intersectionPoints=[];void 0===b.styleMap&&(b.styleMap=new OpenLayers.StyleMap({"default":new OpenLayers.Style({strokeColor:"#ff00ff",strokeOpacity:.5,strokeWidth:1,strokeDashstyle:"solid",fillColor:"#ff00ff"},{rules:[new OpenLayers.Rule({evaluate:function(a){return a.geometry instanceof OpenLayers.Geometry.LineString},symbolizer:{strokeDashstyle:"longdash"}}),
new OpenLayers.Rule({evaluate:function(a){return a.geometry instanceof OpenLayers.Geometry.Point},symbolizer:{graphicName:"cross",pointRadius:3,strokeWidth:0}}),new OpenLayers.Rule]})}));OpenLayers.Layer.Vector.prototype.initialize.call(this,a,b)},addGuides:function(a,b){for(var d=[],e=0;e<a.length;e++)d[e]=a[e]instanceof OpenLayers.Feature.Vector?a[e]:new OpenLayers.Feature.Vector(a[e]);OpenLayers.Layer.Vector.prototype.addFeatures.call(this,d,b);return d},getLine:function(a){if(a.x1===a.x2)return{m:Infinity,
x:a.x1};var b=(a.y2-a.y1)/(a.x2-a.x1);return{m:b,b:a.y2-b*a.x2}},addLine:function(a){var b=this.map.getMaxExtent();a=Infinity===a.m?new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(a.x,b.top),new OpenLayers.Geometry.Point(a.x,b.bottom)])):new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([this.createWorldBoundaryPoint(a.m,b.left,a.b,b),this.createWorldBoundaryPoint(a.m,b.right,a.b,b)]));this.addFeatures([a]);this.rebuildIntersectionPoints();
return a},createWorldBoundaryPoint:function(a,b,d,e){var f=a*b+d;b=f>e.top?(e.top-d)/a:f<e.bottom?(e.bottom-d)/a:b;return new OpenLayers.Geometry.Point(b,a*b+d)},rebuildIntersectionPoints:function(){var a=this.map.getMaxExtent();this.removeFeatures(this.intersectionPoints);this.intersectionPoints=[];this.features.forEach(function(b){b.geometry instanceof OpenLayers.Geometry.Curve&&b.geometry.getSortedSegments().forEach(function(b){var e=this.getLine(b);this.features.forEach(function(b){b.geometry instanceof
OpenLayers.Geometry.Curve&&b.geometry.getSortedSegments().forEach(function(b){b=this.getLine(b);if(e.m!==b.m){b=(b.b-e.b)/(e.m-b.m);var d=e.m*b+e.b;b>=a.left&&b<=a.right&&d>=a.bottom&&d<=a.top&&this.intersectionPoints.push(new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(b,d)))}},this)},this)},this)},this);this.addFeatures(this.intersectionPoints)},removeFeatures:function(a,b){OpenLayers.Layer.Vector.prototype.removeFeatures.apply(this,arguments);a!==this.intersectionPoints&&this.rebuildIntersectionPoints()},
drawFeature:function(a,b){var d=OpenLayers.Layer.Vector.prototype.drawFeature.apply(this,arguments);if(this.unrenderedFeatures[a.id]===a){var e=this.map.getExtent();if(a.geometry.intersects(e.toGeometry()))if(a.geometry instanceof OpenLayers.Geometry.LineString&&2===a.geometry.components.length){var f=a.geometry.getSortedSegments()[0],g=this.getLine(f);Infinity===g.m?(d=new OpenLayers.Geometry.Point(g.x,e.top),g=new OpenLayers.Geometry.Point(g.x,e.bottom)):(d=this.createWorldBoundaryPoint(g.m,e.left,
g.b,e),g=this.createWorldBoundaryPoint(g.m,e.right,g.b,e));e=a.geometry.components[0];e.x=d.x;e.y=d.y;var h=a.geometry.components[1];h.x=g.x;h.y=g.y;d=OpenLayers.Layer.Vector.prototype.drawFeature.apply(this,arguments);e.x=f.x1;e.y=f.y1;h.x=f.x2;h.y=f.y2}else console.warn("Failed to render a feature",a)}return d},moveTo:function(a,b,d){OpenLayers.Layer.Vector.prototype.moveTo.apply(this,arguments);this.features.forEach(function(a){this.drawFeature(a)},this)}});OpenLayers.Editor.Control.SnappingSettings=OpenLayers.Class(OpenLayers.Control.Button,{title:OpenLayers.i18n("oleSnappingSettings"),layer:null,snapping:new OpenLayers.Control.Snapping,tolerance:10,snappingLayers:null,snappingGuideLayer:null,layerListDiv:null,toleranceInput:null,initialize:function(a,b){this.snappingLayers=[];this.layer=a;OpenLayers.Control.Button.prototype.initialize.apply(this,[b]);this.trigger=OpenLayers.Function.bind(this.openSnappingDialog,this);this.events.register("deactivate",
this,this.onDeactivate);this.title=OpenLayers.i18n("oleSnappingSettings")},deactivate:function(){OpenLayers.Control.Button.prototype.deactivate.call(this);this.map&&this.map.editor&&this.map.editor.dialog&&this.map.editor.dialog.hide()},onDeactivate:function(){this.snapping.active&&this.activate()},openSnappingDialog:function(){var a,b;this.activate();this.layerListDiv=document.createElement("div");a=document.createElement("div");b=document.createElement("h4");b.innerHTML=OpenLayers.i18n("oleSnappingSettingsTolerance");
a.appendChild(b);this.toleranceInput=document.createElement("input");this.toleranceInput.type="text";this.toleranceInput.size=4;this.toleranceInput.value=this.tolerance;a.appendChild(this.toleranceInput);a.appendChild(document.createTextNode(OpenLayers.i18n("olePixelUnit")));b=document.createElement("h4");b.innerHTML=OpenLayers.i18n("oleSnappingSettingsLayer");a.appendChild(b);a.appendChild(this.layerListDiv);this.map.editor.dialog.show({content:a,title:OpenLayers.i18n("oleSnappingSettings"),close:OpenLayers.Function.bind(this.changeSnapping,
this)});this.redraw()},redraw:function(){var a,b,d;this.layerListDiv.innerHTML="";for(var e=0;e<this.map.layers.length;e++)a=this.map.layers[e],a instanceof OpenLayers.Layer.Vector.RootContainer||!(a instanceof OpenLayers.Layer.Vector)||a instanceof OpenLayers.Editor.Layer.Snapping||-1!=a.name.search(/OpenLayers.Handler.+/)||(d=document.createElement("div"),b=document.createElement("input"),b.type="checkbox",b.name="snappingLayer",b.id="Snapping."+a.id,b.value="true",0<=this.snappingLayers.indexOf(a)&&
(b.checked="checked",b.defaultChecked="selected"),d.appendChild(b),OpenLayers.Event.observe(b,"click",OpenLayers.Function.bind(this.setLayerSnapping,this,a,b.checked)),b=document.createElement("label"),b.setAttribute("for","Snapping."+a.id),b.innerHTML=a.name,OpenLayers.Event.observe(b,"click",OpenLayers.Function.bind(function(a){OpenLayers.Event.stop(a,!0)},this)),d.appendChild(b),this.layerListDiv.appendChild(d))},setLayerSnapping:function(a,b){b?this.snappingLayers.splice(this.snappingLayers.indexOf(a),
1):this.snappingLayers.push(a);this.redraw()},changeSnapping:function(){this.tolerance=parseInt(this.toleranceInput.value,10);if(0<this.snappingLayers.length){this.snapping.deactivate();for(var a=[],b=0;b<this.snappingLayers.length;b++)a.push({layer:this.snappingLayers[b],tolerance:this.tolerance});this.snapping=new OpenLayers.Control.Snapping({layer:this.layer,targets:a});for(b=0;b<a.length;b++){var d=a[b].layer;if(!1===d.visibility)for(var e=0,f=d.strategies.length;e<f;e++)"OpenLayers.Strategy.BBOX"===
d.strategies[e].CLASS_NAME&&d.strategies[e].update({force:!0})}this.snapping.activate()}else this.snapping.active&&(this.snapping.deactivate(),this.snapping.targets=null);this.snapping.active||this.deactivate()},setMap:function(a){OpenLayers.Control.Button.prototype.setMap.apply(this,arguments);null===this.snappingGuideLayer&&(this.snappingGuideLayer=this.createSnappingGuideLayer())},createSnappingGuideLayer:function(){var a=new OpenLayers.Editor.Layer.Snapping(OpenLayers.i18n("Snapping Layer"),{visibility:!1});
this.map.addLayer(a);return a},CLASS_NAME:"OpenLayers.Editor.Control.SnappingSettings"});OpenLayers.Editor.Control.DownloadFeature=OpenLayers.Class(OpenLayers.Control,{EVENT_TYPES:["featuredownloaded"],layer:null,title:OpenLayers.i18n("oleDownloadFeature"),url:"",params:{action:"download",mime:"text/plain",filename:"editor",encoding:"none"},formats:[{name:"GeoJSON",fileExt:".json",mimeType:"text/plain",formatter:"OpenLayers.Format.GeoJSON"}],fileProjection:null,formatters:{},initialize:function(a,b){this.layer=a;this.title=OpenLayers.i18n("oleDownloadFeature");OpenLayers.Control.Button.prototype.initialize.apply(this,
[b])},activate:function(){var a=OpenLayers.Control.prototype.activate.call(this);a&&this.openDialog();return a},deactivate:function(){var a=OpenLayers.Control.prototype.deactivate.call(this);a&&this.dialog&&(this.dialog.hide(),this.dialog=null);return a},cancelDialog:function(){this.dialog=null;this.deactivate()},openDialog:function(){if(!this.layer.features||0>=this.layer.features.length)this.showMessage(OpenLayers.i18n("oleDownloadFeatureEmpty")),this.deactivate();else{var a=document.createElement("div"),
b=document.createElement("p");b.innerHTML=OpenLayers.i18n("oleDownloadFeatureFileFormat");a.appendChild(b);b=document.createElement("form");b.setAttribute("id","download_form");b.setAttribute("method","POST");b.setAttribute("action",this.url);var d=document.createElement("select");d.setAttribute("name","format_select");d.setAttribute("id","format_select");for(var e,f=0;f<this.formats.length;++f){e=document.createElement("option");var g=this.formats[f],h=g.formatter;"string"==typeof h&&(h=eval("new "+
h+"()"));h.fileProjection=g.fileProjection;this.formatters[g.name]=h;e.setAttribute("value",g.name);e.innerHTML=g.name;e.fileExt=g.fileExt;e.mimeType=g.mimeType;e.sourceFormat=h.CLASS_NAME.split(".")[2];e.targetFormat=g.targetFormat;e.assignSrs=g.fileProjection?g.fileProjection.getCode():void 0;e.sourceSrs=g.sourceSrs?e.sourceSrs:e.assignSrs;e.targetSrs=g.targetSrs;d.appendChild(e)}b.appendChild(d);a.appendChild(b);this.dialog=this.map.editor.dialog;this.dialog.show({title:OpenLayers.i18n("oleDownloadFeature"),
content:a,save:OpenLayers.Function.bind(this.downloadFeature,this),cancel:OpenLayers.Function.bind(this.cancelDialog,this),noHideOnSave:!0})}},downloadFeature:function(){var a=document.getElementById("format_select"),a=a.options[a.selectedIndex],b=this.formatters[a.value];if(!b)return null;this.fileProjection&&(b.internalProjection=this.layer.map.baseLayer.projection,b.externalProjection=b.fileProjection?b.fileProjection:this.fileProjection);b.srsName=b.externalProjection?b.externalProjection.getCode():
this.layer.map.projection;var b=b.write(this.layer.features),d=document.getElementById("download_form"),e=this.params.filename;this.params.filename=e+a.fileExt;this.params.mime=a.mimeType;this.params.data=b;this.params.source_format=a.sourceFormat;this.params.target_format=a.targetFormat;this.params.assign_srs=a.assignSrs;this.params.source_srs=a.sourceSrs;this.params.target_srs=a.targetSrs;for(var f in this.params)this.params[f]&&(d=this.createInputElm(f,"hidden",this.params[f],d));this.params.filename=
e;d.submit();var g=this;setTimeout(function(){g.deactivate()},2E3)},showMessage:function(a){this.map.editor.dialog.show({title:OpenLayers.i18n("oleDownloadFeature"),content:a})},createInputElm:function(a,b,d,e){var f=document.createElement("input");f.setAttribute("type",b);f.name=a;f.value=d?d:null;e&&e.appendChild(f);return e},CLASS_NAME:"OpenLayers.Editor.Control.DownloadFeature"});OpenLayers.Editor.Control.UploadFeature=OpenLayers.Class(OpenLayers.Control,{EVENT_TYPES:["featureuploaded"],layer:null,title:OpenLayers.i18n("oleUploadFeature"),url:"",params:{action:"upload",mime:"text/html",encoding:"escape"},formats:[{name:"GeoJSON",fileExt:".json",mimeType:"text/plain",formatter:"OpenLayers.Format.GeoJSON"}],fileProjection:null,visibleOnUpload:!0,formatters:{},replaceFeatures:!1,initialize:function(a,b){this.layer=a;this.title=OpenLayers.i18n("oleUploadFeature");OpenLayers.Control.Button.prototype.initialize.apply(this,
[b])},activate:function(){var a=OpenLayers.Control.prototype.activate.call(this);a&&this.openDialog();return a},deactivate:function(){var a=OpenLayers.Control.prototype.deactivate.call(this);a&&this.cleanUp(this);return a},cleanUp:function(a){this.getDialog().hide();a.iframe&&a.removeIFrame()},delayedOpenDialog:function(){var a=this;setTimeout(function(){a.openDialog()},200)},getDialog:function(){if(this.map&&this.map.editor&&this.map.editor.dialog)return this.map.editor.dialog;this.dialog||(this.dialog=
new OpenLayers.Editor.Control.Dialog,this.map.addControl(this.dialog));return this.dialog},openDialog:function(){var a=document.createElement("div");a.appendChild(document.createElement("p"));var b=document.createElement("form");b.setAttribute("id","upload_form");b.setAttribute("method","POST");b.setAttribute("action",this.url);b.setAttribute("target","upload_iframe");b.setAttribute("enctype","multipart/form-data");b.setAttribute("encoding","multipart/form-data");var b=this.createInputElm("oleFile",
"file","file",null,b),d=document.createElement("select");d.setAttribute("name","format_select");d.setAttribute("id","format_select");for(var e,f=0;f<this.formats.length;++f){e=document.createElement("option");var g=this.formats[f],h=g.formatter;"string"==typeof h&&(h=eval("new "+h+"()"));h.fileProjection=g.fileProjection;this.formatters[g.name]=h;e.setAttribute("value",g.name);e.innerHTML=g.name;e.fileExt=g.fileExt;e.mimeType=g.mimeType;e.params={};g.targetSrs&&(e.params.target_srs=g.targetSrs);g.sourceSrs&&
(e.params.source_srs=g.sourceSrs);d.appendChild(e)}b.appendChild(d);var d=document.createElement("p"),l=document.createElement("input");l.type="checkbox";l.id="oleUploadFeatureReplace";l.name="uploadFeatureReplace";l.value="true";l.checked=!0;l.defaultChecked=!0;this.setReplaceFeatures(l.checked);d.appendChild(l);OpenLayers.Event.observe(d,"click",OpenLayers.Function.bind(function(a){OpenLayers.Event.stop(a,!0);this.setReplaceFeatures(l.checked)},this));e=document.createElement("label");e.htmlFor=
"oleUploadFeatureReplace";e.appendChild(document.createTextNode(OpenLayers.i18n("oleUploadFeatureReplace")));d.appendChild(e);b.appendChild(d);for(var k in this.params)b=this.createInputElm(null,k,"hidden",this.params[k],b);a.appendChild(b);this.showUploadDialog(a);var n=this;document.getElementById("oleFile").onchange=function(a){if(a=n.fileInputValue(this))if(a=a.split("."),1<a.length){a="."+a[a.length-1].toLowerCase();for(var b=document.getElementById("format_select"),d=b.options,e=0;e<d.length;++e)if(a==
d[e].fileExt){b.selectedIndex=e;break}}}},showMessage:function(a,b){this.getDialog().show({title:OpenLayers.i18n("oleUploadFeature"),content:a,close:b})},showUploadDialog:function(a){this.getDialog().show({title:OpenLayers.i18n("oleUploadFeature"),content:a,save:OpenLayers.Function.bind(this.uploadFeature,this),cancel:OpenLayers.Function.bind(this.cancel,this),saveButtonText:"oleDialogOkButton",noHideOnSave:!0})},createIFrame:function(a){var b=document.createElement("iframe");b.setAttribute("id",
a);b.setAttribute("name",a);b.setAttribute("width","0");b.setAttribute("height","0");b.setAttribute("border","0");b.setAttribute("style","width: 0; height: 0; border: none;");b.src="about:blank";return b},removeIFrame:function(){var a=document.getElementById("upload_iframe");a&&a.parentNode.removeChild(a);this.iframe=null},cancel:function(){this.deactivate()},parseFeatures:function(a){var b=document.getElementById("format_select"),b=this.formatters[b.options[b.selectedIndex].value];if(!b)return null;
this.fileProjection&&(b.internalProjection=this.layer.map.baseLayer.projection,b.externalProjection=b.fileProjection?b.fileProjection:this.fileProjection);a=b.read(a);if(!a||1>a.length)return null;var d;a.constructor!=Array&&(a=[a]);for(b=0;b<a.length;++b)d?d.extend(a[b].geometry.getBounds()):d=a[b].geometry.getBounds();this.bounds=d;return a},uploadFeature:function(){var a=document.getElementById("oleFile");if(this.fileInputValue(a)){this.iframe=this.createIFrame("upload_iframe");document.body.appendChild(this.iframe);
var b=this,d=b.iframe,e=function(){d.detachEvent?d.detachEvent("onload",e):d.removeEventListener("load",e,!1);var a;d.contentDocument?a=d.contentDocument.body.innerHTML:d.contentWindow?a=d.contentWindow.document.body.innerHTML:d.document&&(a=d.document.body.innerHTML);a&&"escape"==b.params.encoding&&(a=a.replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&"));a=b.parseFeatures(a);b.replaceFeatures&&b.layer.destroyFeatures();a?(b.layer.addFeatures(a),b.layer.map.zoomToExtent(b.bounds),
b.visibleOnUpload&&b.layer.setVisibility(!0),setTimeout(function(){b.deactivate()},250)):(b.deactivate(),b.showMessage(OpenLayers.i18n("oleUploadFeatureNone")))};d.addEventListener&&d.addEventListener("load",e,!0);d.attachEvent&&d.attachEvent("onload",e);var a=document.getElementById("upload_form"),f=document.getElementById("format_select"),f=f.options[f.selectedIndex],g;for(g in f.params)a=this.createInputElm(null,g,"hidden",f.params[g],a);a.submit()}else this.cleanUp(this),this.showMessage(OpenLayers.i18n("oleUploadFeatureNoFile"),
OpenLayers.Function.bind(this.delayedOpenDialog,this))},createInputElm:function(a,b,d,e,f){var g=document.createElement("input");g.setAttribute("type",d);g.id=a;g.name=b;g.value=e?e:null;f&&f.appendChild(g);return f},fileInputValue:function(a){return a.files?1==a.files.length?a.files[0].name:null:a.value},setReplaceFeatures:function(a){this.replaceFeatures=a},CLASS_NAME:"OpenLayers.Editor.Control.UploadFeature"});OpenLayers.Editor.Control.SplitFeature=OpenLayers.Class(OpenLayers.Control.DrawFeature,{proxy:null,title:OpenLayers.i18n("oleSplitFeature"),initialize:function(a,b){OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[a,OpenLayers.Handler.Path,b]);this.events.register("activate",this,this.test);this.title=OpenLayers.i18n("oleSplitFeature");this.displayClass="oleControlDisabled "+this.displayClass},test:function(){1>this.layer.selectedFeatures.length&&this.deactivate()},drawFeature:function(a){a=
new OpenLayers.Feature.Vector(a);var b=new OpenLayers.Format.WKT,d=this.layer.events.triggerEvent("sketchcomplete",{feature:a});this.deactivate();!1!==d&&0<this.layer.selectedFeatures.length&&(d=b.write(this.layer.selectedFeatures),a=b.write(a),this.map.editor.startWaiting(this.panel_div),OpenLayers.Request.POST({url:this.map.editor.oleUrl+"process/split",data:OpenLayers.Util.getParameterString({cut:a,geo:d}),headers:{"Content-Type":"application/x-www-form-urlencoded"},callback:this.map.editor.requestComplete,
proxy:this.proxy,scope:this.map.editor}))},CLASS_NAME:"OpenLayers.Editor.Control.SplitFeature"});OpenLayers.Editor.Control.UndoRedo=OpenLayers.Class(OpenLayers.Control,{layer:null,handler:null,autoActivate:!0,KEY_Z:90,KEY_Y:89,onUndo:function(){},onRedo:function(){},onRemoveFeature:function(){},undoStack:null,redoStack:null,currentState:null,initialize:function(a,b){this.layer=a;OpenLayers.Control.prototype.initialize.apply(this,[b]);this.layer.events.register("featureadded",this,this.register);this.layer.events.register("afterfeaturemodified",this,this.register);this.undoStack=[];this.redoStack=
[]},draw:function(){this.handler=new OpenLayers.Handler.Keyboard(this,{keydown:this.handleKeydown})},handleKeydown:function(a){a.keyCode===this.KEY_Z&&!0===a.ctrlKey&&!1===a.shiftKey?this.undo():!0===a.ctrlKey&&(a.keyCode===this.KEY_Y||a.keyCode===this.KEY_Z&&!0===a.shiftKey)&&this.redo()},undo:function(){var a=this.moveBetweenStacks(this.undoStack,this.redoStack,!0);if(a)this.onUndo(a)},redo:function(){var a=this.moveBetweenStacks(this.redoStack,this.undoStack,!1);if(a)this.onRedo(a)},moveBetweenStacks:function(a,
b,d){if(0<a.length)if(this.map.editor.editLayer.removeAllFeatures(),a=a.pop(),b.push(this.currentState),a){b=Array(e);var e=a.length;for(d=0;d<e;++d)b[d]=a[d].clone();this.currentState=b;this.map.editor.editLayer.addFeatures(a,{silent:!0})}else this.currentState=null;else this.currentState&&d&&(b.push(this.currentState),this.map.editor.editLayer.removeAllFeatures(),this.currentState=null)},register:function(){for(var a=this.map.editor.editLayer.features,b=a.length,d=Array(b),e=0;e<b;++e)d[e]=a[e].clone();
this.currentState&&this.undoStack.push(this.currentState);this.currentState=d;this.redoStack=[]},CLASS_NAME:"OpenLayers.Editor.Control.UndoRedo"});OpenLayers.Editor.Control.CADTools=OpenLayers.Class(OpenLayers.Control.Button,{title:OpenLayers.i18n("oleCADTools"),layer:null,parallelDrawingButton:null,guidedDrawingButton:null,tolerance:10,fixedAngleDrawingControl:null,parallelDrawingControl:null,snappingControl:null,initialize:function(a,b){this.layer=a;this.fixedAngleDrawingControl=new OpenLayers.Editor.Control.FixedAngleDrawing(a);this.parallelDrawingControl=new OpenLayers.Editor.Control.ParallelDrawing(a);OpenLayers.Control.Button.prototype.initialize.apply(this,
[b]);this.trigger=OpenLayers.Function.bind(this.openCADToolsDialog,this);this.events.register("deactivate",this,this.onDeactivate);this.title=OpenLayers.i18n("oleCADTools")},activate:function(){map.deActiveAllControls();var a=OpenLayers.Control.Button.prototype.activate.call(this);a&&this.snappingControl.activate();return a},deactivate:function(){var a=OpenLayers.Control.Button.prototype.deactivate.call(this);a&&this.snappingControl.deactivate();return a},onDeactivate:function(){this.deactivate();
this.map.editor.dialog.hide()},setMap:function(a){OpenLayers.Control.Button.prototype.setMap.call(this,a);this.map.addControl(this.fixedAngleDrawingControl);this.map.addControl(this.parallelDrawingControl);this.snappingControl=new OpenLayers.Control.Snapping({layer:this.layer,targets:[{layer:this.map.getLayersByClass("OpenLayers.Editor.Layer.Snapping")[0],tolerance:this.tolerance}]})},openCADToolsDialog:function(){if(this.active)this.deactivate(),this.map.editor.dialog.hide();else{this.activate();
var a,b;a=document.createElement("div");b=document.createElement("div");b.className="olEditorControlEditorCustomPanel olEditorCADToolsToolbar";b.style.top="10px";b.style.right="10px";this.parallelDrawingButton=document.createElement("div");this.parallelDrawingButton.title=OpenLayers.i18n("oleCADToolsDialogParallelDrawing");this.parallelDrawingButton.className=this.parallelDrawingControl.active?"olEditorParallelDrawingActive":"olEditorParallelDrawingInactive";OpenLayers.Event.observe(this.parallelDrawingButton,
"click",OpenLayers.Function.bind(function(){this.parallelDrawingControl.active?(this.parallelDrawingControl.deactivate(),this.parallelDrawingButton.className="olEditorParallelDrawingInactive"):(this.parallelDrawingControl.activate(),this.parallelDrawingButton.className="olEditorParallelDrawingActive")},this,this.parallelDrawingButton));b.appendChild(this.parallelDrawingButton);this.guidedDrawingButton=document.createElement("div");this.guidedDrawingButton.title=OpenLayers.i18n("oleCADToolsDialogGuidedDrawing");
this.guidedDrawingButton.className=this.fixedAngleDrawingControl.active?"olEditorGuidedDrawingActive":"olEditorGuidedDrawingInactive";OpenLayers.Event.observe(this.guidedDrawingButton,"click",OpenLayers.Function.bind(function(){this.fixedAngleDrawingControl.active?(this.fixedAngleDrawingControl.deactivate(),this.guidedDrawingButton.className="olEditorGuidedDrawingInactive"):(this.fixedAngleDrawingControl.activate(),this.guidedDrawingButton.className="olEditorGuidedDrawingActive")},this,this.guidedDrawingButton));
b.appendChild(this.guidedDrawingButton);a.appendChild(b);var d=document.createElement("div"),e=document.createElement("p"),f=document.createElement("input");f.type="checkbox";f.id="oleCADToolsDialogShowLayer";f.name="guidedDrawing";f.value="true";f.checked=!0;f.defaultChecked=!0;this.setShowGuides(f.checked);e.appendChild(f);OpenLayers.Event.observe(e,"click",OpenLayers.Function.bind(function(a){OpenLayers.Event.stop(a,!0);this.setShowGuides(f.checked)},this));b=document.createElement("label");b.htmlFor=
"oleCADToolsDialogShowLayer";b.appendChild(document.createTextNode(OpenLayers.i18n("oleCADToolsDialogShowLayer")));e.appendChild(b);d.appendChild(e);e=document.createElement("p");b=document.createElement("input");b.type="text";b.id="oleCADToolsDialogTolerance";b.size=4;b.value=this.tolerance;OpenLayers.Event.observe(b,"change",OpenLayers.Function.bind(function(a){this.setTolerance(a.target.value)},this));e.appendChild(b);b=document.createElement("label");b.htmlFor="oleCADToolsDialogTolerance";b.appendChild(document.createTextNode(OpenLayers.i18n("oleCADToolsDialogTolerance")));
e.appendChild(b);d.appendChild(e);a.appendChild(d);this.map.editor.dialog.show({content:a,toolbox:!0})}},setTolerance:function(a){this.tolerance=a;this.snappingControl.setTargets([{layer:this.map.getLayersByClass("OpenLayers.Editor.Layer.Snapping")[0],tolerance:this.tolerance}])},setShowGuides:function(a){this.map.getLayersByClass("OpenLayers.Editor.Layer.Snapping")[0].setVisibility(a)},CLASS_NAME:"OpenLayers.Editor.Control.CADTools"});OpenLayers.Editor.Control.ParallelDrawing=OpenLayers.Class(OpenLayers.Control,{CLASS_NAME:"OpenLayers.Editor.Control.ParallelDrawing",active:!1,guideLine:null,guideLineSegment:null,initialize:function(a){OpenLayers.Control.prototype.initialize.call(this);this.layer=a},activate:function(){var a=OpenLayers.Control.prototype.activate.call(this);if(a)this.layer.events.on({pointadded:this.closestSegment,sketchcomplete:this.onSketchComplete,scope:this});return a},deactivate:function(){var a=OpenLayers.Control.prototype.deactivate.call(this);
a&&this.layer.events.un({pointadded:this.closestSegment,sketchcomplete:this.onSketchComplete,scope:this});return a},closestSegment:function(a){var b=null,d=Number.MAX_VALUE;this.layer.features.forEach(function(e){var f=[];e.geometry instanceof OpenLayers.Geometry.Curve?f=e.geometry.getSortedSegments():e.geometry instanceof OpenLayers.Geometry.Polygon&&e.geometry.components.forEach(function(a){a.getSortedSegments().forEach(function(a){f.push(a)})});f.forEach(function(e){if(null===this.guideLineSegment||
this.guideLineSegment.x1!==e.x1||this.guideLineSegment.y1!==e.y1||this.guideLineSegment.x2!==e.x2||this.guideLineSegment.y2!==e.y2){var f=(new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(e.x1,e.y1),new OpenLayers.Geometry.Point(e.x2,e.y2)])).distanceTo(new OpenLayers.Geometry.Point(a.point.x,a.point.y));f<d&&(d=f,b=e)}},this)},this);if(b){this.guideLineSegment=b;this.removeGuides();var e=this.getSnappingGuideLayer(),f=e.getLine(b);f.b+=a.point.y-(f.m*a.point.x+f.b);this.guideLine=
e.addLine(f)}},getSnappingGuideLayer:function(){return this.map.getLayersByClass("OpenLayers.Editor.Layer.Snapping")[0]},onSketchComplete:function(){this.removeGuides()},removeGuides:function(){null!==this.guideLine&&this.getSnappingGuideLayer().removeFeatures([this.guideLine]);this.guideLine=null}});OpenLayers.CustomEditor=OpenLayers.Class(OpenLayers.Editor,{map:null,id:null,editLayer:null,editorPanel:null,editMode:!1,dialog:null,showStatus:function(a,b){"error"===a&&alert(b)},activeControls:[],editorControls:"CleanFeature DeleteFeature DeleteAllFeatures Dialog DrawHole DrawRegular DrawPolygon DrawPath GDrawPath DrawPoint GDrawPoint DrawText EditorPanel EditorCustomPanel ImportFeature MergeFeature SnappingSettings SplitFeature CADTools TransformFeature ContextMenu".split(" "),featureTypes:["text",
"point","path","polygon","regular"],sourceLayers:[],params:{},geoJSON:new OpenLayers.Format.GeoJSON,options:{},oleUrl:"",controls:{},undoRedoActive:!0,initialize:function(a,b){OpenLayers.Util.extend(this,b);this.map=a instanceof OpenLayers.Map?a:new OpenLayers.Map;b||(b={});b.dialog||(this.dialog=new OpenLayers.Editor.Control.Dialog,this.map.addControl(this.dialog));this.id=OpenLayers.Util.createUniqueID("OpenLayers.Editor_");this.editLayer=b.editLayer?b.editLayer:new OpenLayers.Layer.Vector("Editor",
{displayInLayerSwitcher:!1});this.editLayer.styleMap=b.styleMap?b.styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillColor:"#EC5781",fillOpacity:.8,strokeColor:"#E11A51",strokeWidth:2,graphicZIndex:1,pointRadius:5}),defaultLabel:new OpenLayers.Style({fillColor:"#EC5781",fillOpacity:.8,strokeColor:"#E11A51",strokeWidth:2,graphicZIndex:11,pointRadius:0,cursor:"default",label:"${label}",fontColor:"#000000",fontSize:"11px",fontFamily:"Verdana, Arial, Helvetica, sans-serif",fontWeight:"bold",
labelOutlineColor:"#FFFFFF",labelOutlineWidth:4,labelSelect:!0}),select:new OpenLayers.Style({fillColor:"#fc0",strokeColor:"#f70",graphicZIndex:2,pointRadius:10,strokeWidth:4}),selectLabel:new OpenLayers.Style({pointRadius:5,label:"${label}",fontColor:"black",fontSize:"11px",fontFamily:"Verdana, Arial, Helvetica, sans-serif",fontWeight:"bold",labelAlign:"cm",labelXOffset:"${xOffset}",labelYOffset:"${yOffset}",fillColor:"#fc0",strokeColor:"#f70",labelOutlineColor:"#fc0",labelOutlineWidth:6,graphicZIndex:2}),
temporary:new OpenLayers.Style({fillColor:"#fc0",fillOpacity:.8,strokeColor:"#f70",strokeWidth:2,graphicZIndex:2,pointRadius:5}),rdl_stlt_ps:new OpenLayers.Style({externalGraphic:"/images/usolver/road/RDL_STLT_PS_ON_ico.png",graphicWidth:18,graphicHeight:18,fillOpacity:1,graphicZIndex:1}),wtl_pipe_lm:new OpenLayers.Style({fillColor:"#E12626",strokeColor:"#E12626",strokeWidth:2,strokeDashstyle:"dash",graphicZIndex:1}),wtl_sply_ls:new OpenLayers.Style({fillColor:"#E12626",strokeColor:"#E12626",strokeDashstyle:"dash",
strokeWidth:2,graphicZIndex:1}),wtl_meta_ps:new OpenLayers.Style({externalGraphic:"/images/usolver/water/WTL_META_PS_ON_ico.png",graphicWidth:15,graphicHeight:15,fillOpacity:1}),rdl_tree_ps:new OpenLayers.Style({externalGraphic:"/images/usolver/road/RDL_TREE_PS_ON_ico.png",graphicWidth:15,graphicHeight:15,fillOpacity:1})});var d={editor:this,layer:this.editLayer,controls:["OpenLayers.Editor.Control.DeleteFeature","OpenLayers.Editor.Control.CleanFeature","OpenLayers.Editor.Control.MergeFeature","OpenLayers.Editor.Control.SplitFeature"]};
this.editLayer.events.register("featureselected",d,this.selectionChanged);this.editLayer.events.register("featureunselected",d,this.selectionChanged);for(var e=0,f=this.featureTypes.length;e<f;e++)"polygon"==this.featureTypes[e]?this.activeControls.push("DrawPolygon"):"path"==this.featureTypes[e]?this.activeControls.push("GDrawPath"):"point"==this.featureTypes[e]?this.activeControls.push("GDrawPoint"):"regular"==this.featureTypes[e]?this.activeControls.push("DrawRegular"):"text"==this.featureTypes[e]&&
this.activeControls.push("DrawText");e=0;for(f=this.sourceLayers.length;e<f;e++)d={editor:this,layer:this.sourceLayers[e],controls:["OpenLayers.Editor.Control.ImportFeature"]},this.sourceLayers[e].events.register("featureselected",d,this.selectionChanged),this.sourceLayers[e].events.register("featureunselected",d,this.selectionChanged),this.sourceLayers[e].styleMap=new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillColor:"#0c0",fillOpacity:.8,strokeColor:"#070",strokeWidth:2,graphicZIndex:1,
pointRadius:5}),select:new OpenLayers.Style({fillColor:"#fc0",strokeColor:"#f70",graphicZIndex:2}),temporary:new OpenLayers.Style({fillColor:"#fc0",fillOpacity:.8,strokeColor:"#f70",strokeWidth:2,graphicZIndex:2,pointRadius:5})}),this.map.addLayer(this.sourceLayers[e]);this.map.editor=this;this.map.addLayer(this.editLayer);this.map.addControl(new OpenLayers.Editor.Control.LayerSettings(this));this.undoRedoActive&&this.map.addControl(new OpenLayers.Editor.Control.UndoRedo(this.editLayer));this.addEditorControls();
return this},selectionChanged:function(){var a=this.editor.editorPanel.getControlsByClass("OpenLayers.Control.SelectFeature")[0];if(0<this.layer.selectedFeatures.length&&a&&a.active)for(var a=0,b=this.controls.length;a<b;a++){var d=this.editor.editorPanel.getControlsByClass(this.controls[a])[0];d&&OpenLayers.Element.removeClass(d.panel_div,"oleControlDisabled")}else for(a=0,b=this.controls.length;a<b;a++)(d=this.editor.editorPanel.getControlsByClass(this.controls[a])[0])&&OpenLayers.Element.addClass(d.panel_div,
"oleControlDisabled");this.editor.editorPanel.redraw()},startEditMode:function(){this.editMode=!0;this.editorPanel.activate()},stopEditMode:function(){this.editMode=!1;this.editorPanel.deactivate()},addEditorControls:function(){for(var a=null,b=[],d=0,e=this.activeControls.length;d<e;d++){a=this.activeControls[d];-1<OpenLayers.Util.indexOf(this.editorControls,a)&&b.push(new OpenLayers.Editor.Control[a](this.editLayer,OpenLayers.Util.extend({id:a},this.options[a])));switch(a){case "Separator":b.push(new OpenLayers.Control.Button({id:a,
displayClass:"olControlSeparator"}));break;case "Navigation":b.push(new OpenLayers.Control.Navigation(OpenLayers.Util.extend({id:a,title:OpenLayers.i18n("oleNavigation")},this.options.Navigation)));break;case "CustomDragFeature":b.push(new OpenLayers.Editor.Control.CustomDragFeature(this.editLayer,OpenLayers.Util.extend({id:a},this.options.DragFeature)));break;case "CustomModifyFeature":b.push(new OpenLayers.Editor.Control.CustomModifyFeature(this.editLayer,OpenLayers.Util.extend({id:a,title:OpenLayers.i18n("oleModifyFeature")},
this.options.ModifyFeature)));break;case "CustomTransformFeature":b.push(new OpenLayers.Editor.Control.CustomTransformFeature(this.editLayer,OpenLayers.Util.extend({id:a},this.options.TransformFeature)));break;case "CustomSnappingSettings":b.push(new OpenLayers.Editor.Control.CustomSnappingSettings(this.editLayer,OpenLayers.Util.extend({id:a},this.options.SnappingSettings)));break;case "SelectFeature":b.push(new OpenLayers.Control.SelectFeature(this.sourceLayers.concat([this.editLayer]),OpenLayers.Util.extend({id:a,
title:OpenLayers.i18n("oleSelectFeature"),clickout:!0,toggle:!1,multiple:!1,hover:!1,toggleKey:"ctrlKey",multipleKey:"ctrlKey",box:!0},this.options.SelectFeature)));break;case "DownloadFeature":b.push(new OpenLayers.Editor.Control.DownloadFeature(this.editLayer,OpenLayers.Util.extend({id:a},this.DownloadFeature)));break;case "UploadFeature":b.push(new OpenLayers.Editor.Control.UploadFeature(this.editLayer,OpenLayers.Util.extend({id:a},this.UploadFeature)))}this.controls[a]=b[b.length-1]}this.editorPanel=
this.createEditorPanel(b);this.map.addControl(this.editorPanel)},addEditorControl:function(a){this.controls[a.CLASS_NAME]=a;this.editorPanel.addControls([a]);this.map.addControl(a)},createEditorPanel:function(a){if(this.controls.ContextMenu){for(var b=this.controls.ContextMenu.contextMenuControls||[],d=b.length;d--;){var e=a.indexOf(this.controls[b[d]]);~e&&a.splice(e,1)}a.splice(a.indexOf(this.controls.ContextMenu),1)}b=new OpenLayers.Editor.Control.EditorCustomPanel(this);b.addControls(a);return b},
status:function(a){"error"==a.type&&alert(a.content)},loadFeatures:function(a){this.editLayer.destroyFeatures();a&&(this.editLayer.addFeatures(a),this.map.zoomToExtent(this.editLayer.getDataExtent()))},requestComplete:function(a){a=(new OpenLayers.Format.JSON).read(a.responseText);this.map.editor.stopWaiting();a?a.error?this.showStatus("error",a.message):(a.params&&OpenLayers.Util.extend(this.params,a.params),a.geo&&(a=this.geoJSON.read(a.geo),this.editLayer.removeFeatures(this.editLayer.selectedFeatures),
this.editLayer.addFeatures(this.toFeatures(a)),this.editLayer.events.triggerEvent("featureselected"))):this.showStatus("error",OpenLayers.i18n("oleNoJSON"))},toFeatures:function(a){if(null===a||"object"!==typeof a)throw Error("Parameter does not match expected type.");var b=[];a instanceof Array||(a=[a]);for(var d=0,e=a.length;d<e;d++)if("OpenLayers.Geometry.MultiPolygon"===a[d].geometry.CLASS_NAME||"OpenLayers.Geometry.Collection"===a[d].geometry.CLASS_NAME)for(var f=0,g=a[d].geometry.components.length;f<
g;f++)b.push(new OpenLayers.Feature.Vector(a[d].geometry.components[f]));else"OpenLayers.Geometry.Polygon"===a[d].geometry.CLASS_NAME&&b.push(new OpenLayers.Feature.Vector(a[d].geometry));return b},toMultiPolygon:function(a){for(var b=[],d=0,e=a.length;d<e;d++)"OpenLayers.Geometry.Polygon"===a[d].geometry.CLASS_NAME&&b.push(a[d].geometry);return new OpenLayers.Geometry.MultiPolygon(b)},startWaiting:function(a){OpenLayers.Element.addClass(a,"olEditorWaiting");OpenLayers.Element.addClass(this.map.div,
"olEditorWaiting");this.waitingDiv=a},stopWaiting:function(){OpenLayers.Element.removeClass(this.waitingDiv,"olEditorWaiting");OpenLayers.Element.removeClass(this.map.div,"olEditorWaiting")},isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)},getControlById:function(a){for(var b in this.controls)if(b==a)return this.controls[b]},deActivateAllEditControls:function(){for(var a in this.controls)c=this.controls[a],c.deactivate()},activateControls:function(a){map.deActiveAllControls();
if(this.isArray(a))for(var b=0;b<a.length;b++){var d=this.controls[a[b]];if(d.type==OpenLayers.Control.TYPE_BUTTON){d.trigger();break}if(d.type==OpenLayers.Control.TYPE_TOGGLE){d.active?d.deactivate():d.activate();break}if(this.allowDepress&&d.active)d.deactivate();else{var e,f;for(f in this.controls)e=this.controls[f],e!=d&&-1==a.indexOf(e.id)&&e.deactivate();d.activate()}}else{d=this.getControl(a);if(!this.active)return!1;if(d.type==OpenLayers.Control.TYPE_BUTTON)d.trigger();else if(d.type==OpenLayers.Control.TYPE_TOGGLE)d.active?
d.deactivate():d.activate();else if(this.allowDepress&&d.active)d.deactivate();else{for(f in this.controls)e=this.controls[f],e!=d&&-1==a.indexOf(e.id)&&e.deactivate();d.activate()}}},CLASS_NAME:"OpenLayers.CustomEditor"});
OpenLayers.Editor.Control.CustomDragFeature=OpenLayers.Class(OpenLayers.Editor.Control.DragFeature,{title:OpenLayers.i18n("oleDragFeature"),EVENT_TYPES:"activate deactivate dragstart dragdrag dragcomplete dragenter dragleave".split(" "),initialize:function(a,b){OpenLayers.Control.DragFeature.prototype.initialize.apply(this,[a,b]);this.title=OpenLayers.i18n("oleDragFeature")},onStart:function(a,b){var d=a.length;if(0<d)for(var e=[],f=0,g,h,l=0;l<d;l++)if(e=a[l].geometry.getVertices(),f=e.length,0<
f)for(var k=0;k<f;k++)g=e[k].x,h=e[k].y,0!=k&&k!=f-1||alert("["+k+"]"+g+","+h)},onComplete:function(a,b){var d=String();selFid?d=selFid:USV.oPreSearchResult&&1==USV.oPreSearchResult.data[0].results.length&&(d=USV.oPreSearchResult.data[0].results[0].g2id);fn_check_SpatialValueChange(a,$("div.editLayer").attr("id"),d)},CLASS_NAME:"OpenLayers.Editor.Control.CustomDragFeature"});
OpenLayers.Editor.Control.CustomTransformFeature=OpenLayers.Class(OpenLayers.Editor.Control.TransformFeature,{editLayer:null,initialize:function(a){this.strategiesOnHold=[];OpenLayers.Control.TransformFeature.prototype.initialize.call(this,a,{renderIntent:"transform",rotationHandleSymbolizer:"rotate",id:"CustomTransformFeature"});this.editLayer=a;this.addStyles();this.events.on({transformcomplete:function(a){var d=String();selFid?d=selFid:1==USV.oPreSearchResult.data[0].results.length&&(d=_searchResult.data[0].results[0].g2id);
fn_check_SpatialValueChange(a.feature,$("div.editLayer").attr("id"),d);for(var d=0,e=styleVectorLayer.features.length;d<e;d++)if(a.feature.attributes.fid==styleVectorLayer.features[d].attributes.fid){styleVectorLayer.destroyFeatures(styleVectorLayer.features[d],{silent:!0});var f=a.feature.attributes.fid.split(".")[0],g=fn_get_EditLayerType(f),h=editor.getPosListByGeometry(a.feature.geometry);feature=editor.makeFeatureByPosList(g,h,a.feature.attributes.fid);fn_add_StyleVectorLayer(feature,f,a.feature.attributes.fid.split(".")[1]);
styleVectorLayer.drawFeature(feature,f.toLowerCase());editVectorLayer.drawFeature(a.feature,"select")}a.feature.state=OpenLayers.State.UPDATE;this.editLayer.events.triggerEvent("afterfeaturemodified",{feature:a.feature})},scope:this});this.title=OpenLayers.i18n("oleTransformFeature")},createControl:function(){var a=this;this.dragControl=new OpenLayers.Control.DragFeature(this.layer,{documentDrag:!0,moveFeature:function(b){this.feature===a.feature&&(this.feature=a.box);OpenLayers.Control.DragFeature.prototype.moveFeature.apply(this,
arguments)},onDrag:function(b,d){b===a.box&&a.transformFeature({center:a.center})},onStart:function(b,d){var e=!a.geometryTypes||-1!==OpenLayers.Util.indexOf(a.geometryTypes,b.geometry.CLASS_NAME),f=OpenLayers.Util.indexOf(a.handles,b),f=f+OpenLayers.Util.indexOf(a.rotationHandles,b);b!==a.feature&&b!==a.box&&-2==f&&e&&a.setFeature(b)},onComplete:function(b,d){a.events.triggerEvent("transformcomplete",{feature:a.feature})}})},CLASS_NAME:"OpenLayers.Editor.Control.CustomTransformFeature"});
OpenLayers.Editor.Control.CustomModifyFeature=OpenLayers.Class(OpenLayers.Control.ModifyFeature,{initialize:function(a,b){b=b||{};this.layer=a;this.vertices=[];this.virtualVertices=[];this.virtualStyle=OpenLayers.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer(null,b.vertexRenderIntent));this.virtualStyle.fillOpacity=.3;this.virtualStyle.strokeOpacity=.3;this.deleteCodes=[46,68];this.mode=OpenLayers.Control.ModifyFeature.RESHAPE;OpenLayers.Control.prototype.initialize.apply(this,
[b]);OpenLayers.Util.isArray(this.deleteCodes)||(this.deleteCodes=[this.deleteCodes]);var d={documentDrag:this.documentDrag,stopDown:!1};this.handlers={keyboard:new OpenLayers.Handler.Keyboard(this,{keydown:this.handleKeypress}),drag:new OpenLayers.Handler.Drag(this,{down:function(a){this.vertex=null;(a=this.layer.getFeatureFromEvent(this.handlers.drag.evt))?this.dragStart(a):this.clickout&&(this._unselect=this.feature)},move:function(a){delete this._unselect;this.vertex&&this.dragVertex(this.vertex,
a)},up:function(){this.handlers.drag.stopDown=!1;this._unselect&&(this.unselectFeature(this._unselect),delete this._unselect)},done:function(a){this.vertex&&this.dragComplete(this.vertex)}},d)}},dragStart:function(a){var b="OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME;this.standalone||(a._sketch||!b)&&a._sketch||(this.toggle&&this.feature===a&&(this._unselect=a),this.selectFeature(a));if(a._sketch||b)this.vertex=a,this.handlers.drag.stopDown=!0},dragVertex:function(a,b){var d=this.map.getLonLatFromViewPortPx(b),
e=a.geometry;e.move(d.lon-e.x,d.lat-e.y);this.modified=!0;"OpenLayers.Geometry.Point"==this.feature.geometry.CLASS_NAME?this.layer.events.triggerEvent("vertexmodified",{vertex:a.geometry,feature:this.feature,pixel:b}):(a._index?(a.geometry.parent.addComponent(a.geometry,a._index),delete a._index,OpenLayers.Util.removeItem(this.virtualVertices,a),this.vertices.push(a)):a==this.dragHandle?(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],
{silent:!0}),this.radiusHandle=null)):a!==this.radiusHandle&&this.layer.events.triggerEvent("vertexmodified",{vertex:a.geometry,feature:this.feature,pixel:b}),0<this.virtualVertices.length&&(this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.layer.drawFeature(this.feature,this.standalone?void 0:"select"));this.layer.drawFeature(a)},dragComplete:function(a){a=String();selFid?a=selFid:1==USV.oPreSearchResult.data[0].results.length&&(a=_searchResult.data[0].results[0].g2id);
fn_check_SpatialValueChange(this.feature,$("div.editLayer").attr("id"),a);a=0;for(var b=styleVectorLayer.features.length;a<b;a++)if(this.feature.attributes.fid==styleVectorLayer.features[a].attributes.fid){styleVectorLayer.destroyFeatures(styleVectorLayer.features[a],{silent:!0});var d=this.feature.attributes.fid.split(".")[0],e=fn_get_EditLayerType(d),f=editor.getPosListByGeometry(this.feature.geometry);feature=editor.makeFeatureByPosList(e,f,this.feature.attributes.fid);fn_add_StyleVectorLayer(feature,
d,this.feature.attributes.fid.split(".")[1]);styleVectorLayer.drawFeature(feature,d.toLowerCase());editVectorLayer.drawFeature(this.feature,"select")}this.resetVertices();this.setFeatureState();this.onModification(this.feature);this.layer.events.triggerEvent("featuremodified",{feature:this.feature})},setFeatureState:function(){if(this.feature.state!=OpenLayers.State.INSERT&&this.feature.state!=OpenLayers.State.DELETE&&(this.feature.state=OpenLayers.State.UPDATE,this.modified&&this._originalGeometry)){var a=
this.feature;a.modified=OpenLayers.Util.extend(a.modified,{geometry:this._originalGeometry});delete this._originalGeometry}},CLASS_NAME:"OpenLayers.Editor.Control.CustomModifyFeature"});
OpenLayers.Editor.Control.EditorCustomPanel=OpenLayers.Class(OpenLayers.Editor.Control.EditorPanel,{autoActivate:!1,initialize:function(a,b){OpenLayers.Control.Panel.prototype.initialize.apply(this,[b])},draw:function(){OpenLayers.Control.Panel.prototype.draw.apply(this,arguments);this.active||(this.div.style.display="none");return this.div},redraw:function(){this.active||(this.div.style.display="none");OpenLayers.Control.Panel.prototype.redraw.apply(this,arguments);this.active&&(this.div.style.display=
"")},activateControl:function(a){map.deActiveAllControls();if(!this.active)return!1;if(a.type==OpenLayers.Control.TYPE_BUTTON)a.trigger();else if(a.type==OpenLayers.Control.TYPE_TOGGLE)a.active?a.deactivate():a.activate();else if(this.allowDepress&&a.active)a.deactivate();else{for(var b,d=0,e=this.controls.length;d<e;d++)b=this.controls[d],b==a||b.type!==OpenLayers.Control.TYPE_TOOL&&null!=b.type||b.deactivate();a.activate()}},CLASS_NAME:"OpenLayers.Editor.Control.EditorCustomPanel"});
GDrawPath=OpenLayers.Class(OpenLayers.Editor.Control.DrawPath,{minLength:0,title:OpenLayers.i18n("oleDrawPath"),featureType:"path",initialize:function(a,b){this.callbacks=OpenLayers.Util.extend(this.callbacks,{point:function(a){this.layer.events.triggerEvent("pointadded",{point:a})}});OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[a,OpenLayers.Handler.Path,b]);this.title=OpenLayers.i18n("oleDrawPath")},activate:function(){if(this.active)return!1;this.handler&&
this.handler.activate();this.active=!0;this.map&&OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active");this.events.triggerEvent("activate");return!0},drawFeature:function(a){var b=new OpenLayers.Feature.Vector(a);if(!1!==this.layer.events.triggerEvent("sketchcomplete",{feature:b})&&a.getLength()>=this.minLength){b.state=OpenLayers.State.INSERT;this.layer.addFeatures([b]);this.featureAdded(b);this.events.triggerEvent("featureadded",{feature:b});a=COMMON.fn_get_editingLayer();
this.layer.drawFeature(b,a.toLowerCase());var d=$("#selApplyLayer").val();MAP_EDITOR.fn_add_featureToEditMonitor(b,this.featureType,a);"WTL_SPLY_LS"==a&&$("#chkLineEndAdd").is(":checked")&&d}},CLASS_NAME:"GDrawPath"});
GDrawPoint=OpenLayers.Class(OpenLayers.Editor.Control.DrawPoint,{title:OpenLayers.i18n("oleDrawPoint"),featureType:"point",initialize:function(a,b){this.callbacks=OpenLayers.Util.extend(this.callbacks,{point:function(a){this.layer.events.triggerEvent("pointadded",{point:a})}});OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[a,OpenLayers.Handler.Point,b]);this.title=OpenLayers.i18n("oleDrawPoint")},drawFeature:function(a){a=new OpenLayers.Feature.Vector(a);
var b=this.layer.events.triggerEvent("sketchcomplete",{feature:a});a.featureType=this.featureType;!1!==b&&(this.events.triggerEvent("beforefeatureadded",{feature:a}),a.state=OpenLayers.State.INSERT,this.layer.addFeatures([a]),this.featureAdded(a),this.events.triggerEvent("featureadded",{feature:a}),b=COMMON.fn_get_editingLayer(),this.layer.drawFeature(a,b.toLowerCase()),MAP_EDITOR.fn_add_featureToEditMonitor(a,this.featureType,b))},CLASS_NAME:"GDrawPoint"});
OpenLayers.Editor.Control.CustomSnappingSettings=OpenLayers.Class(OpenLayers.Editor.Control.SnappingSettings,{title:OpenLayers.i18n("oleSnappingSettings"),layer:null,snapping:new OpenLayers.Control.Snapping,tolerance:10,snappingLayers:null,snappingGuideLayer:null,layerListDiv:null,toleranceInput:null,initialize:function(a,b){this.snappingLayers=[];this.layer=a;this.tolerance=$("#txtSnapDist").val();OpenLayers.Control.Button.prototype.initialize.apply(this,[b]);this.trigger=OpenLayers.Function.bind(this.setSnappingEnv,
this);this.trigger=OpenLayers.Function.bind(this.changeSnapping,this);this.events.register("deactivate",this,this.onDeactivate);this.title=OpenLayers.i18n("oleSnappingSettings")},deactivate:function(){OpenLayers.Control.Button.prototype.deactivate.call(this);this.map&&this.map.editor&&this.map.editor.dialog&&this.map.editor.dialog.hide()},onDeactivate:function(){this.snapping.active&&this.activate()},setSnappingEnv:function(){this.activate()},redraw:function(){var a,b,d;this.layerListDiv.innerHTML=
"";for(var e=0;e<this.map.layers.length;e++)a=this.map.layers[e],a instanceof OpenLayers.Layer.Vector.RootContainer||!(a instanceof OpenLayers.Layer.Vector)||a instanceof OpenLayers.Editor.Layer.Snapping||-1!=a.name.search(/OpenLayers.Handler.+/)||(d=document.createElement("div"),b=document.createElement("input"),b.type="checkbox",b.name="snappingLayer",b.id="Snapping."+a.id,b.value="true",0<=this.snappingLayers.indexOf(a)&&(b.checked="checked",b.defaultChecked="selected"),d.appendChild(b),OpenLayers.Event.observe(b,
"click",OpenLayers.Function.bind(this.setLayerSnapping,this,a,b.checked)),b=document.createElement("label"),b.setAttribute("for","Snapping."+a.id),b.innerHTML=a.name,OpenLayers.Event.observe(b,"click",OpenLayers.Function.bind(function(a){OpenLayers.Event.stop(a,!0)},this)),d.appendChild(b),this.layerListDiv.appendChild(d))},setLayerSnapping:function(a,b){b?this.snappingLayers.push(a):this.snappingLayers.splice(this.snappingLayers.indexOf(a),1)},changeSnapping:function(){this.tolerance=$("#txtSnapDist").val();
if(0<this.snappingLayers.length){this.snapping.deactivate();for(var a=[],b=0;b<this.snappingLayers.length;b++)a.push({layer:this.snappingLayers[b],tolerance:this.tolerance});this.snapping=new OpenLayers.Control.Snapping({layer:this.layer,targets:a});for(b=0;b<a.length;b++){var d=a[b].layer;if(!1===d.visibility)for(var e=0,f=d.strategies.length;e<f;e++)"OpenLayers.Strategy.BBOX"===d.strategies[e].CLASS_NAME&&d.strategies[e].update({force:!0})}this.snapping.activate()}else this.snapping.active&&(this.snapping.deactivate(),
this.snapping.targets=null);this.snapping.active||this.deactivate()},setMap:function(a){OpenLayers.Control.Button.prototype.setMap.apply(this,arguments);null===this.snappingGuideLayer&&(this.snappingGuideLayer=this.createSnappingGuideLayer())},createSnappingGuideLayer:function(){var a=new OpenLayers.Editor.Layer.Snapping(OpenLayers.i18n("Snapping Layer"),{visibility:!1});this.map.addLayer(a);return a},CLASS_NAME:"OpenLayers.Editor.Control.CustomSnappingSettings"});