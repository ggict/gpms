<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="srvyUnSectionDAO">

	<typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap" />
	<typeAlias alias="srvyUnSectionVO" type="kr.go.gg.gpms.srvyunsection.service.model.SrvyUnSectionVO" />


	<select id="srvyUnSectionDAO.list" parameterClass="srvyUnSectionVO" resultClass="srvyUnSectionVO">
		<![CDATA[ 
			/* srvyUnSectionDAO.list */ 
		]]>
		
		select 
			* 
		from(
			select 
				ROW_NUMBER() OVER() rn	
				,count(*) OVER() AS total_count
				,* 
			from (
				select 
					t1.road_no
					,t1.road_name
					,t1.st_point
					,t1.ed_point
					,t2.srvy_year
					,ROAD_TOT_LEN_JYG_Y as total_road_l
					,t2.road_l
					,DO_MANAGE_SCTN_LEN 
					,case 
						when ROAD_TOT_LEN_JYG_Y = 0 
						then 0
						else (t2.road_l / ROAD_TOT_LEN_JYG_Y) * 100
						end persent
				from tn_route_info t1
				left outer join 
				(	
					SELECT
						srvy_year
						, cell_10.route_code route_code
						, coalesce(sum(ROAD_L), 0) / 1000 ROAD_L
					FROM cell_10 
					right outer join tn_mumm_sctn_srvy_dta
					on (
						cell_10.route_code = tn_mumm_sctn_srvy_dta.route_code
						AND cell_10.direct_code = tn_mumm_sctn_srvy_dta.direct_code
						AND cell_10.track = tn_mumm_sctn_srvy_dta.track
						AND cell_10.strtpt = tn_mumm_sctn_srvy_dta.strtpt
						AND cell_10.endpt = tn_mumm_sctn_srvy_dta.endpt
						AND tn_mumm_sctn_srvy_dta.use_at = 'Y'
						AND tn_mumm_sctn_srvy_dta.delete_at = 'N'
					)
					where 1=1
					<isNotEmpty property="SRVY_YEAR">
					AND tn_mumm_sctn_srvy_dta.SRVY_YEAR = #SRVY_YEAR#
					</isNotEmpty>
					<isNotEmpty property="ROAD_NO">
					AND cell_10.route_code = #ROAD_NO#
					</isNotEmpty>
					group by cell_10.route_code, srvy_year
					
				) t2
				on (t1.road_no = t2.route_code)
				where 1=1
				<isNotEmpty property="ROAD_NO">
				AND t1.road_no = #ROAD_NO#
				</isNotEmpty>
				
				order by t1.road_no asc, t2.srvy_year asc
			) as sub_t
			
		) as res	
		where 1=1
		
		<isEqual prepend="  " property="usePage" compareValue="true">
		<![CDATA[
			AND rn BETWEEN #firstIndex# + 1 AND #firstIndex# + #recordCountPerPage#
		]]>
		</isEqual>
		
	</select>
	
	<select id="srvyUnSectionDAO.chartList" parameterClass="srvyUnSectionVO" resultClass="srvyUnSectionVO">
		<![CDATA[ 
			/* srvyUnSectionDAO.chartList */ 
		]]>

		with temp as (
			select 6411799 as dept_code, '북부도로과' as dept_name
			union all
			select 6411399 as dept_code, '도로건설과'as dept_name
		)
		select 
			t1.dept_code, t1.dept_name, total_road_l, road_l, DO_MANAGE_SCTN_LEN  
		from temp t1
		left outer join 
		(
			select
				t2.dept_code
				,coalesce(sum(ROAD_TOT_LEN_JYG_Y),0) as total_road_l
				,coalesce(sum(t2.road_l),0) as road_l
				,coalesce(sum(DO_MANAGE_SCTN_LEN),0) as DO_MANAGE_SCTN_LEN
			from tn_route_info t1
			left outer join 
			(	
				SELECT
					srvy_year
					, dept_code	
					, cell_10.route_code route_code
					, coalesce(sum(ROAD_L), 0) / 1000 ROAD_L
				FROM cell_10 
				right outer join tn_mumm_sctn_srvy_dta
				on (
					cell_10.route_code = tn_mumm_sctn_srvy_dta.route_code
					AND cell_10.direct_code = tn_mumm_sctn_srvy_dta.direct_code
					AND cell_10.track = tn_mumm_sctn_srvy_dta.track
					AND cell_10.strtpt = tn_mumm_sctn_srvy_dta.strtpt
					AND cell_10.endpt = tn_mumm_sctn_srvy_dta.endpt
					AND tn_mumm_sctn_srvy_dta.use_at = 'Y'
					AND tn_mumm_sctn_srvy_dta.delete_at = 'N'
				)
				where 1=1
				<isNotEmpty property="SRVY_YEAR">
				AND tn_mumm_sctn_srvy_dta.SRVY_YEAR = #SRVY_YEAR#
				</isNotEmpty>
				<isNotEmpty property="ROAD_NO">
				AND t1.road_no = #ROAD_NO#
				</isNotEmpty>
				group by cell_10.route_code, cell_10.dept_code, srvy_year
			) t2
			on (t1.road_no = t2.route_code)
			where 1=1
			<isNotEmpty property="ROAD_NO">
			AND t1.road_no = #ROAD_NO#
			</isNotEmpty>
			group by t2.dept_code	
		) as t2
		on(t1.dept_code = t2.dept_code)
		order by t1.dept_code desc	
	</select>
	
	<select id="srvyUnSectionDAO.sectionlocation" parameterClass="srvyUnSectionVO" resultClass="srvyUnSectionVO">
	<![CDATA[
		/* srvyUnSectionDAO.unsectionlocation */
	]]>
	
		select
			route_code
			,ST_AsGeoJSON(ST_Union(t1.geom)) geojson 
			/*
			ST_Collect(t1.geom) geom 
			count(t1.cell_id)
			*/
		from cell_10 t1
		where 1=1 
		<isNotEmpty property="ROUTE_CODE">
		AND t1.route_code = #ROUTE_CODE#
		</isNotEmpty>
		and cell_id in (
				SELECT
					cell_id
				FROM cell_10 
				right outer join tn_mumm_sctn_srvy_dta
				on (
					cell_10.route_code = tn_mumm_sctn_srvy_dta.route_code
					AND cell_10.direct_code = tn_mumm_sctn_srvy_dta.direct_code
					AND cell_10.track = tn_mumm_sctn_srvy_dta.track
					AND cell_10.strtpt = tn_mumm_sctn_srvy_dta.strtpt
					AND cell_10.endpt = tn_mumm_sctn_srvy_dta.endpt
					AND tn_mumm_sctn_srvy_dta.use_at = 'Y'
					AND tn_mumm_sctn_srvy_dta.delete_at = 'N'
				)
				where 1=1
				<isNotEmpty property="SRVY_YEAR">
				AND tn_mumm_sctn_srvy_dta.SRVY_YEAR = #SRVY_YEAR#
				</isNotEmpty>
				<isNotEmpty property="ROUTE_CODE">
				AND cell_10.route_code = #ROUTE_CODE#
				</isNotEmpty>
			)
		group by route_code	
	</select>
	
	<select id="srvyUnSectionDAO.unsectionlocation" parameterClass="srvyUnSectionVO" resultClass="srvyUnSectionVO">
	<![CDATA[
		/* srvyUnSectionDAO.unsectionlocation */
	]]>
	
		select
			route_code
			,ST_AsGeoJSON(ST_Union(t1.geom)) geojson 
			/*
			ST_Collect(t1.geom) geom 
			count(t1.cell_id)
			*/
		from cell_10 t1
		where 1=1 
		<isNotEmpty property="ROUTE_CODE">
		AND t1.route_code = #ROUTE_CODE#
		</isNotEmpty>
		and cell_id not in (
				SELECT
					cell_id
				FROM cell_10 
				right outer join tn_mumm_sctn_srvy_dta
				on (
					cell_10.route_code = tn_mumm_sctn_srvy_dta.route_code
					AND cell_10.direct_code = tn_mumm_sctn_srvy_dta.direct_code
					AND cell_10.track = tn_mumm_sctn_srvy_dta.track
					AND cell_10.strtpt = tn_mumm_sctn_srvy_dta.strtpt
					AND cell_10.endpt = tn_mumm_sctn_srvy_dta.endpt
					AND tn_mumm_sctn_srvy_dta.use_at = 'Y'
					AND tn_mumm_sctn_srvy_dta.delete_at = 'N'
				)
				where 1=1
				<isNotEmpty property="SRVY_YEAR">
				AND tn_mumm_sctn_srvy_dta.SRVY_YEAR = #SRVY_YEAR#
				</isNotEmpty>
				<isNotEmpty property="ROUTE_CODE">
				AND cell_10.route_code = #ROUTE_CODE#
				</isNotEmpty>
			)
		group by route_code	
	</select>
	
	<select id="srvyUnSectionDAO.srvyYearList" parameterClass="srvyUnSectionVO" resultClass="srvyUnSectionVO">
		SELECT 
			SRVY_YEAR
		FROM tn_mumm_sctn_srvy_dta
		GROUP BY SRVY_YEAR
	</select>

</sqlMap>
